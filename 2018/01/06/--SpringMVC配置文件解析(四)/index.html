<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SpringMVC配置文件详解（四） | 迷途书童的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言前面的三篇文章分别讲解了配置文件注册bean的过程、注解注册bean的过程和DispatchServlet的初始化。 那现在我们就可以把目光转向我们使用SpringMVC处理静态资源时的配置的原理了。先来看一下使用 1&amp;lt;mvc:resources location=&quot;/public/stat">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringMVC配置文件详解（四）">
<meta property="og:url" content="https://cong96.github.io/2018/01/06/--SpringMVC配置文件解析(四)/index.html">
<meta property="og:site_name" content="迷途书童的博客">
<meta property="og:description" content="前言前面的三篇文章分别讲解了配置文件注册bean的过程、注解注册bean的过程和DispatchServlet的初始化。 那现在我们就可以把目光转向我们使用SpringMVC处理静态资源时的配置的原理了。先来看一下使用 1&amp;lt;mvc:resources location=&quot;/public/static/*&quot; mapping=&quot;/static/*&quot;/&amp;gt; 来处理静态资源的原理到底是怎样的。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-01-06T18:57:59.835Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SpringMVC配置文件详解（四）">
<meta name="twitter:description" content="前言前面的三篇文章分别讲解了配置文件注册bean的过程、注解注册bean的过程和DispatchServlet的初始化。 那现在我们就可以把目光转向我们使用SpringMVC处理静态资源时的配置的原理了。先来看一下使用 1&amp;lt;mvc:resources location=&quot;/public/static/*&quot; mapping=&quot;/static/*&quot;/&amp;gt; 来处理静态资源的原理到底是怎样的。">
  
    <link rel="alternate" href="/atom.xml" title="迷途书童的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">迷途书童的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一天进步一点</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cong96.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post---SpringMVC配置文件解析(四)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/06/--SpringMVC配置文件解析(四)/" class="article-date">
  <time datetime="2018-01-06T14:28:04.470Z" itemprop="datePublished">2018-01-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringMVC/">SpringMVC</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SpringMVC配置文件详解（四）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>前面的三篇文章分别讲解了配置文件注册bean的过程、注解注册bean的过程和DispatchServlet的初始化。</p>
<p>那现在我们就可以把目光转向我们使用SpringMVC处理静态资源时的配置的原理了。先来看一下使用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">location</span>=<span class="string">"/public/static/*"</span> <span class="attr">mapping</span>=<span class="string">"/static/*"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>来处理静态资源的原理到底是怎样的。</p>
<h3 id="的解析"><a href="#的解析" class="headerlink" title="\的解析"></a>\<mvc:resource>的解析</mvc:resource></h3><p>在之前我们已经讲解过了\<context:component-scan>的解析过程。这两个标签都属于扩展标签。</context:component-scan></p>
<p>他们的解析都是使用BeanDefinitionParser的相应实现类来解析的，只是他们对应着不同的实现类。</p>
<p>\<context:component-scan>对应着的是ComponentScanBeanDefinitionParser，而\<mvc:resource>对应着的是org.springframework.web.servlet.config.ResourcesBeanDefinitionParser。</mvc:resource></context:component-scan></p>
<p>至于如何找到这个类等问题我就不再说了，直接看这个类的parser方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		Object source = parserContext.extractSource(element);</span><br><span class="line"></span><br><span class="line">		registerUrlProvider(parserContext, source);</span><br><span class="line">	<span class="comment">//得到location属性指定的字符串</span></span><br><span class="line">		String resourceHandlerName = registerResourceHandler(parserContext, element, source);</span><br><span class="line">		<span class="keyword">if</span> (resourceHandlerName == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//new一个urlMap，继承了LinkedHashMap(可以用来做FIFO队列)</span></span><br><span class="line">		Map&lt;String, String&gt; urlMap = <span class="keyword">new</span> ManagedMap&lt;String, String&gt;();</span><br><span class="line">      <span class="comment">//得到mapping属性指定的字符串</span></span><br><span class="line">		String resourceRequestPath = element.getAttribute(<span class="string">"mapping"</span>);</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(resourceRequestPath)) &#123;</span><br><span class="line">			parserContext.getReaderContext().error(<span class="string">"The 'mapping' attribute is required."</span>, parserContext.extractSource(element));</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">      <span class="comment">//以mapping的值为key 以location的值为value,注册到这个urlMap中，</span></span><br><span class="line">		urlMap.put(resourceRequestPath, resourceHandlerName);</span><br><span class="line"></span><br><span class="line">		RuntimeBeanReference pathMatcherRef = MvcNamespaceUtils.registerPathMatcher(<span class="keyword">null</span>, parserContext, source);</span><br><span class="line">		RuntimeBeanReference pathHelperRef = MvcNamespaceUtils.registerUrlPathHelper(<span class="keyword">null</span>, parserContext, source);</span><br><span class="line">	<span class="comment">//生成一个包含SimpleUrlHandlerMapping实例的BeanDefinition</span></span><br><span class="line">		RootBeanDefinition handlerMappingDef = <span class="keyword">new</span> RootBeanDefinition(SimpleUrlHandlerMapping.class);</span><br><span class="line">		handlerMappingDef.setSource(source);</span><br><span class="line">		handlerMappingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">      <span class="comment">//注册SimpleUrlHandlerMapping的urlMap属性</span></span><br><span class="line">		handlerMappingDef.getPropertyValues().add(<span class="string">"urlMap"</span>, urlMap);</span><br><span class="line">      <span class="comment">//如果有指定mvcPathMatcher和mvcUrlPathHelper属性的话，就会注册这两个属性，默认是无，不是重点，先不分析</span></span><br><span class="line">		handlerMappingDef.getPropertyValues().add(<span class="string">"pathMatcher"</span>, pathMatcherRef).add(<span class="string">"urlPathHelper"</span>, pathHelperRef);</span><br><span class="line"></span><br><span class="line">		String order = element.getAttribute(<span class="string">"order"</span>);</span><br><span class="line">		<span class="comment">// Use a default of near-lowest precedence, still allowing for even lower precedence in other mappings</span></span><br><span class="line">      <span class="comment">//如果没有指定order，则把order值指定为MAX-1</span></span><br><span class="line">		handlerMappingDef.getPropertyValues().add(<span class="string">"order"</span>, StringUtils.hasText(order) ? order : Ordered.LOWEST_PRECEDENCE - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		String beanName = parserContext.getReaderContext().generateBeanName(handlerMappingDef);</span><br><span class="line">		parserContext.getRegistry().registerBeanDefinition(beanName, handlerMappingDef);</span><br><span class="line">	<span class="comment">//将SimpleUrlHandlerMapping实例注册到BeanFactory中</span></span><br><span class="line">      parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(handlerMappingDef, beanName));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ensure BeanNameUrlHandlerMapping (SPR-8289) and default HandlerAdapters are not "turned off"</span></span><br><span class="line">		<span class="comment">// Register HttpRequestHandlerAdapter</span></span><br><span class="line">      <span class="comment">//注册默认的mapping adapter等</span></span><br><span class="line">		MvcNamespaceUtils.registerDefaultComponents(parserContext, source);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//注册ResourceHttpRequestHandler</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">registerResourceHandler</span><span class="params">(ParserContext parserContext, Element element, Object source)</span> </span>&#123;</span><br><span class="line">		String locationAttr = element.getAttribute(<span class="string">"location"</span>);</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(locationAttr)) &#123;</span><br><span class="line">			parserContext.getReaderContext().error(<span class="string">"The 'location' attribute is required."</span>, parserContext.extractSource(element));</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ManagedList&lt;String&gt; locations = <span class="keyword">new</span> ManagedList&lt;String&gt;();</span><br><span class="line">		locations.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(locationAttr)));</span><br><span class="line"></span><br><span class="line">		RootBeanDefinition resourceHandlerDef = <span class="keyword">new</span> RootBeanDefinition(ResourceHttpRequestHandler.class);</span><br><span class="line">		resourceHandlerDef.setSource(source);</span><br><span class="line">		resourceHandlerDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">		resourceHandlerDef.getPropertyValues().add(<span class="string">"locations"</span>, locations);</span><br><span class="line"></span><br><span class="line">		String cacheSeconds = element.getAttribute(<span class="string">"cache-period"</span>);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(cacheSeconds)) &#123;</span><br><span class="line">			resourceHandlerDef.getPropertyValues().add(<span class="string">"cacheSeconds"</span>, cacheSeconds);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Element resourceChainElement = DomUtils.getChildElementByTagName(element, <span class="string">"resource-chain"</span>);</span><br><span class="line">		<span class="keyword">if</span> (resourceChainElement != <span class="keyword">null</span>) &#123;</span><br><span class="line">			parseResourceChain(resourceHandlerDef, parserContext, resourceChainElement, source);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		String beanName = parserContext.getReaderContext().generateBeanName(resourceHandlerDef);</span><br><span class="line">		parserContext.getRegistry().registerBeanDefinition(beanName, resourceHandlerDef);</span><br><span class="line">		parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(resourceHandlerDef, beanName));</span><br><span class="line">		<span class="keyword">return</span> beanName;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法具体做了什么代码里已经分析的比较明白了，这个方法最后就是给我们注册了一个SimpleUrlHandlerMapping实例到Spring容器中，并且为这个实例注入了urlMap属性和order属性。</p>
<p>很明显这个实例会在初始化DispatchServlet的时候注入到该类的handlerMappings属性中。</p>
<p>而此时，当一个对静态资源的请求过来时，他依旧还是会走DispatchServlet，但是这个时候，就不会再产生404 not found错误了。这是为什么呢？因为虽然在RequestMappingHandlerMapping(oreder为0)和BeanNameUrlHandlerMapping(order为2)中都找不到对应的Handler，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> HandlerExecutionChain <span class="title">getHandler</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (HandlerMapping hm : <span class="keyword">this</span>.handlerMappings) &#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(</span><br><span class="line">					<span class="string">"Testing handler map ["</span> + hm + <span class="string">"] in DispatcherServlet with name '"</span> + getServletName() + <span class="string">"'"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		HandlerExecutionChain handler = hm.getHandler(request);</span><br><span class="line">		<span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> handler;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是此时的handlerMappings中多了一个成员，那就是SimpleUrlHandlerMapping(order为Integer.MAX-1),当静态资源的位置是我们在标签中配置好的location的时候，就能被这个Mapping所处理。那么具体是怎么处理的呢。我们来看一下。</p>
<p>在讲解怎么处理之前，我们需要来关注下这个类的实例化全过程。</p>
<h3 id="SimpleUrlHandlerMapping的实例化"><a href="#SimpleUrlHandlerMapping的实例化" class="headerlink" title="SimpleUrlHandlerMapping的实例化"></a>SimpleUrlHandlerMapping的实例化</h3><p>同样的，我们先来看看他的继承链。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleUrlHandlerMapping</span> <span class="keyword">extends</span> <span class="title">AbstractUrlHandlerMapping</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractUrlHandlerMapping</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMapping</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHandlerMapping</span> <span class="keyword">extends</span> <span class="title">WebApplicationObjectSupport</span></span></span><br><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">HandlerMapping</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WebApplicationObjectSupport</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class">          <span class="title">ApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ServletContextAware</span> </span>&#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationObjectSupport</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletContextAware</span> <span class="keyword">extends</span> <span class="title">Aware</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>哎，我们发现他的祖先类实现了Aware接口，哎哟喂，路子挺野的呀。这个我们上一篇讲过了。直接拿过来用啦。</p>
<p>直接看AbstractAutowireCapableBeanFactory的initializeBean方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, RootBeanDefinition mbd)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">			AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					invokeAwareMethods(beanName, bean);</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, getAccessControlContext());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			invokeAwareMethods(beanName, bean);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object wrappedBean = bean;</span><br><span class="line">		<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">			wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</span><br><span class="line">					(mbd != <span class="keyword">null</span> ? mbd.getResourceDescription() : <span class="keyword">null</span>),</span><br><span class="line">					beanName, <span class="string">"Invocation of init method failed"</span>, ex);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (mbd == <span class="keyword">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">			wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> wrappedBean;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>先瞅一下invokeAwareMethods方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanNameAware) &#123;</span><br><span class="line">			((BeanNameAware) bean).setBeanName(beanName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanClassLoaderAware) &#123;</span><br><span class="line">			((BeanClassLoaderAware) bean).setBeanClassLoader(getBeanClassLoader());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> BeanFactoryAware) &#123;</span><br><span class="line">			((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>蛤？并没有我们这里的接口诶，虽然我们的接口也继承了Aware，但是在这没卵用呀，我们的是ApplicationContextAware和ServletContextAware，这两在这都不管用呀，是不是搞错地方了呀。</p>
<p>别着急，千万别着急，我们还漏了一个地方没有讲。</p>
<p>我们暂时把目光回到AbstractApplicationContext的prepareBeanFactory方法一下下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Tell the internal bean factory to use the context's class loader etc.</span></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Configure the bean factory with context callbacks.</span></span><br><span class="line">		beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中有一个方法叫addBeanPostProcessor，我们进入这个方法看看。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBeanPostProcessor</span><span class="params">(BeanPostProcessor beanPostProcessor)</span> </span>&#123;</span><br><span class="line">	Assert.notNull(beanPostProcessor, <span class="string">"BeanPostProcessor must not be null"</span>);</span><br><span class="line">	<span class="keyword">this</span>.beanPostProcessors.remove(beanPostProcessor);</span><br><span class="line">	<span class="keyword">this</span>.beanPostProcessors.add(beanPostProcessor);</span><br><span class="line">	<span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">		<span class="keyword">this</span>.hasInstantiationAwareBeanPostProcessors = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (beanPostProcessor <span class="keyword">instanceof</span> DestructionAwareBeanPostProcessor) &#123;</span><br><span class="line">		<span class="keyword">this</span>.hasDestructionAwareBeanPostProcessors = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的作用即添加了一个ApplicationContextAwareProcessor实例到BeanFactory的BeanPostProcessor集合中。</p>
<p>我们再回到initializeBean方法，我们已经证明invokeAwareMethods没有对我们这个类实现的接口有什么处理，我们继续往下看，会看到applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);方法，我们来看下这个方法</p>
<p><strong>applyBeanPostProcessorsBeforeInitialization</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">applyBeanPostProcessorsBeforeInitialization</span><span class="params">(Object existingBean, String beanName)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">	Object result = existingBean;</span><br><span class="line">	<span class="keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;</span><br><span class="line">		result = beanProcessor.postProcessBeforeInitialization(result, beanName);</span><br><span class="line">		<span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对BeanFactory的BeanPostProcessor集合进行了遍历，并调用他们的postProcessBeforeInitialization方法，我们已经知道了这个集合中有ApplicationContextAwareProcessor实例，我们来看下他的这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(<span class="keyword">final</span> Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		AccessControlContext acc = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">				(bean <span class="keyword">instanceof</span> EnvironmentAware || bean <span class="keyword">instanceof</span> EmbeddedValueResolverAware ||</span><br><span class="line">						bean <span class="keyword">instanceof</span> ResourceLoaderAware || bean <span class="keyword">instanceof</span> ApplicationEventPublisherAware ||</span><br><span class="line">						bean <span class="keyword">instanceof</span> MessageSourceAware || bean <span class="keyword">instanceof</span> ApplicationContextAware)) &#123;</span><br><span class="line">			acc = <span class="keyword">this</span>.applicationContext.getBeanFactory().getAccessControlContext();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (acc != <span class="keyword">null</span>) &#123;</span><br><span class="line">			AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">					invokeAwareInterfaces(bean);</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, acc);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			invokeAwareInterfaces(bean);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> bean;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareInterfaces</span><span class="params">(Object bean)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Aware) &#123;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EnvironmentAware) &#123;</span><br><span class="line">				((EnvironmentAware) bean).setEnvironment(<span class="keyword">this</span>.applicationContext.getEnvironment());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EmbeddedValueResolverAware) &#123;</span><br><span class="line">				((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(</span><br><span class="line">						<span class="keyword">new</span> EmbeddedValueResolver(<span class="keyword">this</span>.applicationContext.getBeanFactory()));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ResourceLoaderAware) &#123;</span><br><span class="line">				((ResourceLoaderAware) bean).setResourceLoader(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationEventPublisherAware) &#123;</span><br><span class="line">				((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> MessageSourceAware) &#123;</span><br><span class="line">				((MessageSourceAware) bean).setMessageSource(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationContextAware) &#123;</span><br><span class="line">				((ApplicationContextAware) bean).setApplicationContext(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>皇天不负有心人，终于找到了，实现了ApplicationContextAware接口的Bean，在初始化的过程中，都会调用他的setApplicationContext方法。</p>
<p>现在我们就来看看</p>
<p>我们发现setApplicationContext只有在祖先类ApplicationObjectSupport中有实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext context)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (context == <span class="keyword">null</span> &amp;&amp; !isContextRequired()) &#123;</span><br><span class="line">			<span class="comment">// Reset internal context state.</span></span><br><span class="line">			<span class="keyword">this</span>.applicationContext = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">this</span>.messageSourceAccessor = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// Initialize with passed-in context.</span></span><br><span class="line">			<span class="keyword">if</span> (!requiredContextClass().isInstance(context)) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</span><br><span class="line">						<span class="string">"Invalid application context: needs to be of type ["</span> + requiredContextClass().getName() + <span class="string">"]"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.applicationContext = context;</span><br><span class="line">			<span class="keyword">this</span>.messageSourceAccessor = <span class="keyword">new</span> MessageSourceAccessor(context);</span><br><span class="line">			initApplicationContext(context);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Ignore reinitialization if same context passed in.</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.applicationContext != context) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</span><br><span class="line">						<span class="string">"Cannot reinitialize with different application context: current one is ["</span> +</span><br><span class="line">						<span class="keyword">this</span>.applicationContext + <span class="string">"], passed-in one is ["</span> + context + <span class="string">"]"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>而其中最重要的方法initApplicationContext方法在该类中是个空方法，也就是说这个方法是留个子类来实现的。</p>
<p>下面的类都实现了这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//WebApplicationObjectSupport</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">(ApplicationContext context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.initApplicationContext(context);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.servletContext == <span class="keyword">null</span> &amp;&amp; context <span class="keyword">instanceof</span> WebApplicationContext) &#123;</span><br><span class="line">			<span class="keyword">this</span>.servletContext = ((WebApplicationContext) context).getServletContext();</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.servletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">				initServletContext(<span class="keyword">this</span>.servletContext);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//AbstractHandlerMapping</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		extendInterceptors(<span class="keyword">this</span>.interceptors);</span><br><span class="line">		detectMappedInterceptors(<span class="keyword">this</span>.mappedInterceptors);</span><br><span class="line">		initInterceptors();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//SimpleUrlHandlerMapping</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initApplicationContext</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.initApplicationContext();</span><br><span class="line">		registerHandlers(<span class="keyword">this</span>.urlMap);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>所以在调用SimpleUrlHandlerMapping的initApplicationContext会调用AbstractHandlerMapping的initApplicationContext方法，而他的这个方法主要是初始化拦截器，这个不是我们现在要说的重点，这个以后会细说，拦截器是很多框架中的一个重要组成部分。</p>
<p>我们现在就直接看SimpleUrlHandlerMapping的initApplicationContext方法中的    registerHandlers(this.urlMap);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandlers</span><span class="params">(Map&lt;String, Object&gt; urlMap)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (urlMap.isEmpty()) &#123;</span><br><span class="line">			logger.warn(<span class="string">"Neither 'urlMap' nor 'mappings' set on SimpleUrlHandlerMapping"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : urlMap.entrySet()) &#123;</span><br><span class="line">				String url = entry.getKey();</span><br><span class="line">				Object handler = entry.getValue();</span><br><span class="line">				<span class="comment">// Prepend with slash if not already present.</span></span><br><span class="line">				<span class="keyword">if</span> (!url.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">					url = <span class="string">"/"</span> + url;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// Remove whitespace from handler bean name.</span></span><br><span class="line">				<span class="keyword">if</span> (handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">					handler = ((String) handler).trim();</span><br><span class="line">				&#125;</span><br><span class="line">				registerHandler(url, handler);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandler</span><span class="params">(String urlPath, Object handler)</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">		Assert.notNull(urlPath, <span class="string">"URL path must not be null"</span>);</span><br><span class="line">		Assert.notNull(handler, <span class="string">"Handler object must not be null"</span>);</span><br><span class="line">		Object resolvedHandler = handler;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Eagerly resolve handler if referencing singleton via name.</span></span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.lazyInitHandlers &amp;&amp; handler <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">			String handlerName = (String) handler;</span><br><span class="line">			<span class="keyword">if</span> (getApplicationContext().isSingleton(handlerName)) &#123;</span><br><span class="line">				resolvedHandler = getApplicationContext().getBean(handlerName);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Object mappedHandler = <span class="keyword">this</span>.handlerMap.get(urlPath);</span><br><span class="line">		<span class="keyword">if</span> (mappedHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (mappedHandler != resolvedHandler) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">						<span class="string">"Cannot map "</span> + getHandlerDescription(handler) + <span class="string">" to URL path ["</span> + urlPath +</span><br><span class="line">						<span class="string">"]: There is already "</span> + getHandlerDescription(mappedHandler) + <span class="string">" mapped."</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (urlPath.equals(<span class="string">"/"</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">"Root mapping to "</span> + getHandlerDescription(handler));</span><br><span class="line">				&#125;</span><br><span class="line">				setRootHandler(resolvedHandler);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (urlPath.equals(<span class="string">"/*"</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">"Default mapping to "</span> + getHandlerDescription(handler));</span><br><span class="line">				&#125;</span><br><span class="line">				setDefaultHandler(resolvedHandler);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">this</span>.handlerMap.put(urlPath, resolvedHandler);</span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">"Mapped URL path ["</span> + urlPath + <span class="string">"] onto "</span> + getHandlerDescription(handler));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getHandlerDescription</span><span class="params">(Object handler)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"handler "</span> + (handler <span class="keyword">instanceof</span> String ? <span class="string">"'"</span> + handler + <span class="string">"'"</span> : <span class="string">"of type ["</span> + handler.getClass() + <span class="string">"]"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>代码不难理解，就是讲SimpleUrlHandlerMapping中的urlMap的匹配信息转到AbstractUrlHandlerMapping中的handlerMap中。这样就完成了注册。</p>
<p>说完了这两个HandlerMapping的实例化，那你对没有讲到的BeanNameUrlHandlerMapping的初始化流程也不会觉得难了。</p>
<p>讲解完了初始化之后，又该讲到处理请求了。</p>
<p>getHandler得到的会是一个ResourceHttpRequestHandler实例。</p>
<p>通过AbstractUrlHandlerMapping的lookupHandler得到，不难理解吧，看下源码很容易得出。什么细节都讲的话太多了。</p>
<p>然后就要看ha.supports(handler);到底选中哪个了，ResourceHttpRequestHandler实现了HttpRequestHandler接口，所以是HttpRequestHandlerAdapter。</p>
<p>handle方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	((HttpRequestHandler) handler).handleRequest(request, response);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，我们处理的是一个静态资源，所以返回一个空的ModelAndView对象。</p>
<p>所以真正的处理就全在ResourceHttpRequestHandler的handleRequest方法里了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		checkAndPrepare(request, response, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// check whether a matching resource exists</span></span><br><span class="line">		Resource resource = getResource(request);</span><br><span class="line">		<span class="keyword">if</span> (resource == <span class="keyword">null</span>) &#123;</span><br><span class="line">			logger.trace(<span class="string">"No matching resource found - returning 404"</span>);</span><br><span class="line">			response.sendError(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// check the resource's media type</span></span><br><span class="line">		MediaType mediaType = getMediaType(resource);</span><br><span class="line">		<span class="keyword">if</span> (mediaType != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"Determined media type '"</span> + mediaType + <span class="string">"' for "</span> + resource);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">"No media type found for "</span> + resource + <span class="string">" - not sending a content-type header"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// header phase</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">new</span> ServletWebRequest(request, response).checkNotModified(resource.lastModified())) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Resource not modified - returning 304"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		setHeaders(response, resource, mediaType);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// content phase</span></span><br><span class="line">		<span class="keyword">if</span> (METHOD_HEAD.equals(request.getMethod())) &#123;</span><br><span class="line">			logger.trace(<span class="string">"HEAD request - skipping content"</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		writeContent(response, resource);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>使用\<mvc:resources>标签，就把吹静态资源的任务交给了ResourceHttpRequestHandler，由SpringMVC框架自己来完成。</mvc:resources></p>
<h3 id="的解析-1"><a href="#的解析-1" class="headerlink" title="\的解析"></a>\<mvc:default-servlet-handler>的解析</mvc:default-servlet-handler></h3><p>不多说废话了，直接来到DefaultServletHandlerBeanDefinitionParser的parse方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		Object source = parserContext.extractSource(element);</span><br><span class="line"></span><br><span class="line">		String defaultServletName = element.getAttribute(<span class="string">"default-servlet-name"</span>);</span><br><span class="line">		RootBeanDefinition defaultServletHandlerDef = <span class="keyword">new</span> RootBeanDefinition(DefaultServletHttpRequestHandler.class);</span><br><span class="line">		defaultServletHandlerDef.setSource(source);</span><br><span class="line">		defaultServletHandlerDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(defaultServletName)) &#123;</span><br><span class="line">			defaultServletHandlerDef.getPropertyValues().add(<span class="string">"defaultServletName"</span>, defaultServletName);</span><br><span class="line">		&#125;</span><br><span class="line">		String defaultServletHandlerName = parserContext.getReaderContext().generateBeanName(defaultServletHandlerDef);</span><br><span class="line">		parserContext.getRegistry().registerBeanDefinition(defaultServletHandlerName, defaultServletHandlerDef);</span><br><span class="line">		parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(defaultServletHandlerDef, defaultServletHandlerName));</span><br><span class="line"></span><br><span class="line">		Map&lt;String, String&gt; urlMap = <span class="keyword">new</span> ManagedMap&lt;String, String&gt;();</span><br><span class="line">		urlMap.put(<span class="string">"/**"</span>, defaultServletHandlerName);</span><br><span class="line"></span><br><span class="line">		RootBeanDefinition handlerMappingDef = <span class="keyword">new</span> RootBeanDefinition(SimpleUrlHandlerMapping.class);</span><br><span class="line">		handlerMappingDef.setSource(source);</span><br><span class="line">		handlerMappingDef.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">		handlerMappingDef.getPropertyValues().add(<span class="string">"urlMap"</span>, urlMap);</span><br><span class="line"></span><br><span class="line">		String handlerMappingBeanName = parserContext.getReaderContext().generateBeanName(handlerMappingDef);</span><br><span class="line">		parserContext.getRegistry().registerBeanDefinition(handlerMappingBeanName, handlerMappingDef);</span><br><span class="line">		parserContext.registerComponent(<span class="keyword">new</span> BeanComponentDefinition(handlerMappingDef, handlerMappingBeanName));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ensure BeanNameUrlHandlerMapping (SPR-8289) and default HandlerAdapters are not "turned off"</span></span><br><span class="line">		MvcNamespaceUtils.registerDefaultComponents(parserContext, source);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>很显然是将静态资源交由web容器的defaultservlet来处理，这种方式的优先级是最低的，他的order是Integer.MAX，他的具体实现我们明天再看，真的困~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cong96.github.io/2018/01/06/--SpringMVC配置文件解析(四)/" data-id="cjc3psf1v0001vcbz2o98skxz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/07/--SpringMVC配置文件解析(三)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          SpringMVC配置文件解析(三)
        
      </div>
    </a>
  
  
    <a href="/2017/12/24/--Tomcat是如何处理web.xml的（下）/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Tomcat是如何处理web.xml的（下）</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CAS/">CAS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-WEB/">Java WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWEB/">JavaWEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringMVC/">SpringMVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-css/">js&&css</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/02/05/CAS简单实例/">CAS简单实例</a>
          </li>
        
          <li>
            <a href="/2018/02/05/CAS/">CAS</a>
          </li>
        
          <li>
            <a href="/2018/02/05/数据库基础知识/">数据库基础知识</a>
          </li>
        
          <li>
            <a href="/2018/02/05/CAS结合openldap/">CAS结合openldap</a>
          </li>
        
          <li>
            <a href="/2018/01/31/DelegatingFilterProxy/">DelegatingFilterProxy</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>