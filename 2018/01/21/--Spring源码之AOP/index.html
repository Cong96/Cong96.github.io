<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Spring源码之AOP | 迷途书童的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言之前说过了IOC，现在自然要来到AOP了，先来看下配置文件实现的AOP的相关源码解析。 显然还是会用到BeanDefinitionParser接口的实现类。 这里是用ConfigBeanDefinitionParser实现类来完成对\节点的解析。 123456789101112&amp;lt;bean id=&qu">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring源码之AOP">
<meta property="og:url" content="https://cong96.github.io/2018/01/21/--Spring源码之AOP/index.html">
<meta property="og:site_name" content="迷途书童的博客">
<meta property="og:description" content="前言之前说过了IOC，现在自然要来到AOP了，先来看下配置文件实现的AOP的相关源码解析。 显然还是会用到BeanDefinitionParser接口的实现类。 这里是用ConfigBeanDefinitionParser实现类来完成对\节点的解析。 123456789101112&amp;lt;bean id=&quot;xmlHandler&quot; class=&quot;com.tgb.aop.XMLAdvice&quot; /&amp;gt">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-01-21T14:03:10.868Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring源码之AOP">
<meta name="twitter:description" content="前言之前说过了IOC，现在自然要来到AOP了，先来看下配置文件实现的AOP的相关源码解析。 显然还是会用到BeanDefinitionParser接口的实现类。 这里是用ConfigBeanDefinitionParser实现类来完成对\节点的解析。 123456789101112&amp;lt;bean id=&quot;xmlHandler&quot; class=&quot;com.tgb.aop.XMLAdvice&quot; /&amp;gt">
  
    <link rel="alternate" href="/atom.xml" title="迷途书童的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">迷途书童的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一天进步一点</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cong96.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post---Spring源码之AOP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/21/--Spring源码之AOP/" class="article-date">
  <time datetime="2018-01-21T14:07:52.842Z" itemprop="datePublished">2018-01-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spring源码之AOP
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>之前说过了IOC，现在自然要来到AOP了，先来看下配置文件实现的AOP的相关源码解析。</p>
<p>显然还是会用到BeanDefinitionParser接口的实现类。</p>
<p>这里是用ConfigBeanDefinitionParser实现类来完成对\<aop:config>节点的解析。</aop:config></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=<span class="string">"xmlHandler"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.tgb.aop.XMLAdvice"</span> /&gt;  </span><br><span class="line">&lt;aop:config&gt;  </span><br><span class="line">    &lt;aop:aspect id=<span class="string">"aspect"</span> ref=<span class="string">"xmlHandler"</span>&gt;  </span><br><span class="line">        &lt;aop:pointcut id=<span class="string">"pointUserMgr"</span> expression=<span class="string">"execution(* com.tgb.aop.*.find*(..))"</span>/&gt;  </span><br><span class="line">          </span><br><span class="line">        &lt;aop:before method=<span class="string">"doBefore"</span>  pointcut-ref=<span class="string">"pointUserMgr"</span>/&gt;  </span><br><span class="line">        &lt;aop:after method=<span class="string">"doAfter"</span>  pointcut-ref=<span class="string">"pointUserMgr"</span>/&gt;  </span><br><span class="line">        &lt;aop:around method=<span class="string">"doAround"</span>  pointcut-ref=<span class="string">"pointUserMgr"</span>/&gt;  </span><br><span class="line">        &lt;aop:after-returning method=<span class="string">"doReturn"</span>  pointcut-ref=<span class="string">"pointUserMgr"</span>/&gt;  </span><br><span class="line">        &lt;aop:after-throwing method=<span class="string">"doThrowing"</span> throwing=<span class="string">"ex"</span> pointcut-ref=<span class="string">"pointUserMgr"</span>/&gt;  </span><br><span class="line">          </span><br><span class="line">    &lt;/aop:aspect&gt;</span><br></pre></td></tr></table></figure>
<h3 id="ConfigBeanDefinitionParser"><a href="#ConfigBeanDefinitionParser" class="headerlink" title="ConfigBeanDefinitionParser"></a>ConfigBeanDefinitionParser</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">		CompositeComponentDefinition compositeDef =</span><br><span class="line">				<span class="keyword">new</span> CompositeComponentDefinition(element.getTagName(), parserContext.extractSource(element));</span><br><span class="line">		parserContext.pushContainingComponent(compositeDef);</span><br><span class="line"><span class="comment">//向Spring容器注册了一个BeanName为org.springframework.aop.config.internalAutoProxyCreator的Bean定义，可以自定义也可以使用Spring提供的（根据优先级来）</span></span><br><span class="line">      <span class="comment">//深入这个方法你会发现熟悉的proxy-target-class属性 以及一个不是很常用的exposeProxy属性</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	向Spring容器注册了一个BeanName为org.springframework.aop.config.internalAutoProxyCreator的Bean定义，可以自定义也可以使用Spring提供的（根据优先级来）</span></span><br><span class="line"><span class="comment">Spring默认提供的是org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator，这个类是AOP的核心类，留在下篇讲解</span></span><br><span class="line"><span class="comment">在这个方法里面也会根据配置proxy-target-class和expose-proxy，设置是否使用CGLIB进行代理以及是否暴露最终的代理。</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">      </span><br><span class="line">      configureAutoProxyCreator(parserContext, element);</span><br><span class="line"></span><br><span class="line">		List&lt;Element&gt; childElts = DomUtils.getChildElements(element);</span><br><span class="line">		<span class="keyword">for</span> (Element elt: childElts) &#123;</span><br><span class="line">			String localName = parserContext.getDelegate().getLocalName(elt);</span><br><span class="line">			<span class="keyword">if</span> (POINTCUT.equals(localName)) &#123;</span><br><span class="line">				parsePointcut(elt, parserContext);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ADVISOR.equals(localName)) &#123;</span><br><span class="line">				parseAdvisor(elt, parserContext);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (ASPECT.equals(localName)) &#123;</span><br><span class="line">				parseAspect(elt, parserContext);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		parserContext.popAndRegisterContainingComponent();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>我们直接来看解析\<aop:config>的方法。</aop:config></p>
<p>1.调用  configureAutoProxyCreator(parserContext, element);在向Spring容器里注册一个名为</p>
<p><strong>org.springframework.aop.config.internalAutoProxyCreator</strong>的Bean定义，类型默认是</p>
<p><strong>org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator</strong>,</p>
<p>具体实现先不细说。</p>
<p>2.接着往下看，我们的配置文件里面config节点下是aspect，所以我们这里直接看parseAspect(elt, parserContext);这个方法就帮我们解析了aspect节点下的所有配置，是我们今天要关注的重点。</p>
<p><strong>parseAspect(elt, parserContext)</strong></p>
<p>parseAspect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAspect</span><span class="params">(Element aspectElement, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//获取ID和指定的beanName</span></span><br><span class="line">		String aspectId = aspectElement.getAttribute(ID);</span><br><span class="line">		String aspectName = aspectElement.getAttribute(REF);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//往paresState这个栈里面推入一个当前aspcet节点的Entry</span></span><br><span class="line">			<span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> AspectEntry(aspectId, aspectName));</span><br><span class="line">          <span class="comment">//新建一个Bean定义List和BeanReference的List，在将Bean定义转化为Bean的时候会用到</span></span><br><span class="line">			List&lt;BeanDefinition&gt; beanDefinitions = <span class="keyword">new</span> ArrayList&lt;BeanDefinition&gt;();</span><br><span class="line">			List&lt;BeanReference&gt; beanReferences = <span class="keyword">new</span> ArrayList&lt;BeanReference&gt;();</span><br><span class="line"><span class="comment">//如果该aspect节点有declare-parents属性的话，得到其属性对应的值，然后对其进行处理。</span></span><br><span class="line">			List&lt;Element&gt; declareParents = DomUtils.getChildElementsByTagName(aspectElement, DECLARE_PARENTS);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = METHOD_INDEX; i &lt; declareParents.size(); i++) &#123;</span><br><span class="line">				Element declareParentsElement = declareParents.get(i);</span><br><span class="line">				beanDefinitions.add(parseDeclareParents(declareParentsElement, parserContext));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// We have to parse "advice" and all the advice kinds in one loop, to get the</span></span><br><span class="line">			<span class="comment">// ordering semantics right.</span></span><br><span class="line">          <span class="comment">//对aspect下的子节点进行处理。</span></span><br><span class="line">			NodeList nodeList = aspectElement.getChildNodes();</span><br><span class="line">			<span class="keyword">boolean</span> adviceFoundAlready = <span class="keyword">false</span>;</span><br><span class="line">          <span class="comment">//****开始对子节点遍历</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) &#123;</span><br><span class="line">				Node node = nodeList.item(i);</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">              即这个for循环只用来处理&lt;aop:aspect&gt;标签下的&lt;aop:before&gt;、&lt;aop:after&gt;、&lt;aop:after-returning&gt;、&lt;aop:after-throwing method=""&gt;、&lt;aop:around method=""&gt;这五个标签的。</span></span><br><span class="line"><span class="comment">              </span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">				<span class="keyword">if</span> (isAdviceNode(node, parserContext)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (!adviceFoundAlready) &#123;</span><br><span class="line">						adviceFoundAlready = <span class="keyword">true</span>;</span><br><span class="line">						<span class="keyword">if</span> (!StringUtils.hasText(aspectName)) &#123;</span><br><span class="line">							parserContext.getReaderContext().error(</span><br><span class="line">									<span class="string">"&lt;aspect&gt; tag needs aspect bean reference via 'ref' attribute when declaring advices."</span>,</span><br><span class="line">									aspectElement, <span class="keyword">this</span>.parseState.snapshot());</span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						&#125;</span><br><span class="line">                      <span class="comment">//要注入一个包含aspectName的beanReference，在aspectComponentDefinition 转化为Bean的时候会用到</span></span><br><span class="line">						beanReferences.add(<span class="keyword">new</span> RuntimeBeanReference(aspectName));</span><br><span class="line">					&#125;</span><br><span class="line">					AbstractBeanDefinition advisorDefinition = parseAdvice(</span><br><span class="line">							aspectName, i, aspectElement, (Element) node, parserContext, beanDefinitions, beanReferences);</span><br><span class="line">                  <span class="comment">//将advisorDefinition加入到beanDefinitions</span></span><br><span class="line">					beanDefinitions.add(advisorDefinition);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">	<span class="comment">//新建一个aspectComponentDefinition，注入了beanDefinitions beanReferences</span></span><br><span class="line">			AspectComponentDefinition aspectComponentDefinition = createAspectComponentDefinition(</span><br><span class="line">					aspectElement, aspectId, beanDefinitions, beanReferences, parserContext);</span><br><span class="line">			parserContext.pushContainingComponent(aspectComponentDefinition);</span><br><span class="line"></span><br><span class="line">			List&lt;Element&gt; pointcuts = DomUtils.getChildElementsByTagName(aspectElement, POINTCUT);</span><br><span class="line">			<span class="keyword">for</span> (Element pointcutElement : pointcuts) &#123;</span><br><span class="line">				parsePointcut(pointcutElement, parserContext);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			parserContext.popAndRegisterContainingComponent();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.parseState.pop();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>我们直接从对aspect子节点遍历开始看起。</p>
<p>isAdviceNode(node, parserContext)的作用是筛选出了要处理的子节点的名字。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isAdviceNode</span><span class="params">(Node aNode, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!(aNode <span class="keyword">instanceof</span> Element)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		String name = parserContext.getDelegate().getLocalName(aNode);</span><br><span class="line">		<span class="keyword">return</span> (BEFORE.equals(name) || AFTER.equals(name) || AFTER_RETURNING_ELEMENT.equals(name) ||</span><br><span class="line">				AFTER_THROWING_ELEMENT.equals(name) || AROUND.equals(name));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以很清楚的看出，代表只会处理aop:aspect&gt;标签下的\<aop:before>、\<aop:after>、\<aop:after-returning>、\<aop:after-throwing method="">、\<aop:around method="">这五个标签。</aop:around></aop:after-throwing></aop:after-returning></aop:after></aop:before></p>
<p>接着看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractBeanDefinition advisorDefinition = parseAdvice(</span><br><span class="line">						aspectName, i, aspectElement, (Element) node, parserContext, beanDefinitions, beanReferences);</span><br></pre></td></tr></table></figure>
<p>这里正式处理子节点了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">parseAdvice</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			String aspectName, <span class="keyword">int</span> order, Element aspectElement, Element adviceElement, ParserContext parserContext,</span></span></span><br><span class="line"><span class="function"><span class="params">			List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//将当前的节点的信息放入到parseState栈中</span></span><br><span class="line">			<span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> AdviceEntry(parserContext.getDelegate().getLocalName(adviceElement)));</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">			<span class="comment">// create the method factory bean</span></span><br><span class="line">			RootBeanDefinition methodDefinition = <span class="keyword">new</span> RootBeanDefinition(MethodLocatingFactoryBean.class);</span><br><span class="line">			methodDefinition.getPropertyValues().add(<span class="string">"targetBeanName"</span>, aspectName);</span><br><span class="line">			methodDefinition.getPropertyValues().add(<span class="string">"methodName"</span>, adviceElement.getAttribute(<span class="string">"method"</span>));</span><br><span class="line">			methodDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// create instance factory definition</span></span><br><span class="line">			RootBeanDefinition aspectFactoryDef =</span><br><span class="line">					<span class="keyword">new</span> RootBeanDefinition(SimpleBeanFactoryAwareAspectInstanceFactory.class);</span><br><span class="line">			aspectFactoryDef.getPropertyValues().add(<span class="string">"aspectBeanName"</span>, aspectName);</span><br><span class="line">			aspectFactoryDef.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// register the pointcut</span></span><br><span class="line">			AbstractBeanDefinition adviceDef = createAdviceDefinition(</span><br><span class="line">					adviceElement, parserContext, aspectName, order, methodDefinition, aspectFactoryDef,</span><br><span class="line">					beanDefinitions, beanReferences);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// configure the advisor</span></span><br><span class="line">			RootBeanDefinition advisorDefinition = <span class="keyword">new</span> RootBeanDefinition(AspectJPointcutAdvisor.class);</span><br><span class="line">			advisorDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line"><span class="comment">//看方法名就知道，当Adviser Bean定义通过Spring转化为AspectJPointcutAdvisor实例的时候，</span></span><br><span class="line">          <span class="comment">//advise Bean定义对应的AbstractAspectJAdvice实例将作为前者的构造方法的形参注入。</span></span><br><span class="line">          advisorDefinition.getConstructorArgumentValues().addGenericArgumentValue(adviceDef);</span><br><span class="line">		<span class="comment">//如果节点有order属性，要注入order属性</span></span><br><span class="line">          <span class="keyword">if</span> (aspectElement.hasAttribute(ORDER_PROPERTY)) &#123;</span><br><span class="line">				advisorDefinition.getPropertyValues().add(</span><br><span class="line">						ORDER_PROPERTY, aspectElement.getAttribute(ORDER_PROPERTY));</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// register the final advisor</span></span><br><span class="line">		<span class="comment">//注册到Spring容器中，即BeanFactory中	parserContext.getReaderContext().registerWithGeneratedName(advisorDefinition);</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> advisorDefinition;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">//出栈</span></span><br><span class="line">			<span class="keyword">this</span>.parseState.pop();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>1,创建一个Method工厂Bean定义，里面包含的信息有aspectname以及相应节点的method属性值。</p>
<p>2.创建一个aspectFactory工厂Bean定义，里面包含的信息有asepectname.</p>
<p>3.创建一个Advise Bean定义，下面会重点讲解。</p>
<p>4.创建一个Advisor Bean定义，将AdviseBean注入到其中，然后返回。看方法名就知道，当Adviser Bean定义通过Spring转化为AspectJPointcutAdvisor实例的时候，    advise Bean定义对应的AbstractAspectJAdvice实例将作为前者的构造方法的形参注入。</p>
<p>我们重点来看下是如何创建Advise Bean定义的。</p>
<p><strong>createAdviceDefinition</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">createAdviceDefinition</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			Element adviceElement, ParserContext parserContext, String aspectName, <span class="keyword">int</span> order,</span></span></span><br><span class="line"><span class="function"><span class="params">			RootBeanDefinition methodDef, RootBeanDefinition aspectFactoryDef,</span></span></span><br><span class="line"><span class="function"><span class="params">			List&lt;BeanDefinition&gt; beanDefinitions, List&lt;BeanReference&gt; beanReferences)</span> </span>&#123;</span><br><span class="line"><span class="comment">//新建Advice Bean定义</span></span><br><span class="line">		RootBeanDefinition adviceDefinition = <span class="keyword">new</span> RootBeanDefinition(getAdviceClass(adviceElement, parserContext));</span><br><span class="line">		adviceDefinition.setSource(parserContext.extractSource(adviceElement));</span><br><span class="line">	<span class="comment">//注入 aspectName和declarationOrder属性</span></span><br><span class="line">		adviceDefinition.getPropertyValues().add(ASPECT_NAME_PROPERTY, aspectName);</span><br><span class="line">		adviceDefinition.getPropertyValues().add(DECLARATION_ORDER_PROPERTY, order);</span><br><span class="line"><span class="comment">//如果该节点有returning属性，将其注入该Bean定义的returningName属性</span></span><br><span class="line">		<span class="keyword">if</span> (adviceElement.hasAttribute(RETURNING)) &#123;</span><br><span class="line">			adviceDefinition.getPropertyValues().add(</span><br><span class="line">					RETURNING_PROPERTY, adviceElement.getAttribute(RETURNING));</span><br><span class="line">		&#125;</span><br><span class="line">  <span class="comment">//如果该节点有throwing属性，那么将其注入到该Bean定义的throwingName属性</span></span><br><span class="line">		<span class="keyword">if</span> (adviceElement.hasAttribute(THROWING)) &#123;</span><br><span class="line">			adviceDefinition.getPropertyValues().add(</span><br><span class="line">					THROWING_PROPERTY, adviceElement.getAttribute(THROWING));</span><br><span class="line">		&#125;</span><br><span class="line">  <span class="comment">//如果该节点有arg-names属性，那么将其注入到该Bean定义的argumentNames属性</span></span><br><span class="line">		<span class="keyword">if</span> (adviceElement.hasAttribute(ARG_NAMES)) &#123;</span><br><span class="line">			adviceDefinition.getPropertyValues().add(</span><br><span class="line">					ARG_NAMES_PROPERTY, adviceElement.getAttribute(ARG_NAMES));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//很明显这里是为了该Bean定义中的Bean收集构造方法参数信息</span></span><br><span class="line">		ConstructorArgumentValues cav = adviceDefinition.getConstructorArgumentValues();</span><br><span class="line"><span class="comment">//第一个参数 Method		</span></span><br><span class="line">  cav.addIndexedArgumentValue(METHOD_INDEX, methodDef);</span><br><span class="line">	<span class="comment">//第二个参数 pointcut</span></span><br><span class="line">		Object pointcut = parsePointcutProperty(adviceElement, parserContext);</span><br><span class="line">		<span class="keyword">if</span> (pointcut <span class="keyword">instanceof</span> BeanDefinition) &#123;</span><br><span class="line">			cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcut);</span><br><span class="line">			beanDefinitions.add((BeanDefinition) pointcut);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (pointcut <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">			RuntimeBeanReference pointcutRef = <span class="keyword">new</span> RuntimeBeanReference((String) pointcut);</span><br><span class="line">			cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcutRef);</span><br><span class="line">			beanReferences.add(pointcutRef);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">//第三个参数，asepctFactory</span></span><br><span class="line">		cav.addIndexedArgumentValue(ASPECT_INSTANCE_FACTORY_INDEX, aspectFactoryDef);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> adviceDefinition;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>1.通过节点的标签名字来得到要新建的AdviseBean定义的构造方法的入参。</p>
<p>getAdviceClass</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; getAdviceClass(Element adviceElement, ParserContext parserContext) &#123;</span><br><span class="line">		String elementName = parserContext.getDelegate().getLocalName(adviceElement);</span><br><span class="line">		<span class="keyword">if</span> (BEFORE.equals(elementName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> AspectJMethodBeforeAdvice.class;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (AFTER.equals(elementName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> AspectJAfterAdvice.class;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (AFTER_RETURNING_ELEMENT.equals(elementName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> AspectJAfterReturningAdvice.class;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (AFTER_THROWING_ELEMENT.equals(elementName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> AspectJAfterThrowingAdvice.class;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (AROUND.equals(elementName)) &#123;</span><br><span class="line">			<span class="keyword">return</span> AspectJAroundAdvice.class;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown advice kind ["</span> + elementName + <span class="string">"]."</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到五个不同类型的节点都有自己对应的AbstractAdvise实现类。</p>
<p>2.注入一系列的属性</p>
<p>3.注入对应的Bean的构造方法参数。</p>
<p>我们这里主要看注入第二个参数的过程。</p>
<p>我们截取这一段来分析一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Object pointcut = parsePointcutProperty(adviceElement, parserContext);</span><br><span class="line">	<span class="keyword">if</span> (pointcut <span class="keyword">instanceof</span> BeanDefinition) &#123;</span><br><span class="line">		cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcut);</span><br><span class="line">		beanDefinitions.add((BeanDefinition) pointcut);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (pointcut <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">		RuntimeBeanReference pointcutRef = <span class="keyword">new</span> RuntimeBeanReference((String) pointcut);</span><br><span class="line">		cav.addIndexedArgumentValue(POINTCUT_INDEX, pointcutRef);</span><br><span class="line">		beanReferences.add(pointcutRef);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>1.先调用parsePointcutProperty得到我们要注入的pointcut。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">parsePointcutProperty</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (element.hasAttribute(POINTCUT) &amp;&amp; element.hasAttribute(POINTCUT_REF)) &#123;</span><br><span class="line">		parserContext.getReaderContext().error(</span><br><span class="line">				<span class="string">"Cannot define both 'pointcut' and 'pointcut-ref' on &lt;advisor&gt; tag."</span>,</span><br><span class="line">				element, <span class="keyword">this</span>.parseState.snapshot());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (element.hasAttribute(POINTCUT)) &#123;</span><br><span class="line">		<span class="comment">// Create a pointcut for the anonymous pc and register it.</span></span><br><span class="line">		String expression = element.getAttribute(POINTCUT);</span><br><span class="line">		AbstractBeanDefinition pointcutDefinition = createPointcutDefinition(expression);</span><br><span class="line">		pointcutDefinition.setSource(parserContext.extractSource(element));</span><br><span class="line">		<span class="keyword">return</span> pointcutDefinition;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (element.hasAttribute(POINTCUT_REF)) &#123;</span><br><span class="line">		String pointcutRef = element.getAttribute(POINTCUT_REF);</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(pointcutRef)) &#123;</span><br><span class="line">			parserContext.getReaderContext().error(</span><br><span class="line">					<span class="string">"'pointcut-ref' attribute contains empty value."</span>, element, <span class="keyword">this</span>.parseState.snapshot());</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> pointcutRef;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		parserContext.getReaderContext().error(</span><br><span class="line">				<span class="string">"Must define one of 'pointcut' or 'pointcut-ref' on &lt;advisor&gt; tag."</span>,</span><br><span class="line">				element, <span class="keyword">this</span>.parseState.snapshot());</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法有点长，但是很好理解：</p>
<p>1.如果当前节点没有pointcut属性和pointcut-ref属性，那么直接返回null。</p>
<p>2.如果当前节点有pointcut属性，则调用createPointcutDefinition创建一个Bean定义，里面对应的bean是一个AspectJExpressionPointcut实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AbstractBeanDefinition <span class="title">createPointcutDefinition</span><span class="params">(String expression)</span> </span>&#123;</span><br><span class="line">	RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(AspectJExpressionPointcut.class);</span><br><span class="line">	beanDefinition.setScope(BeanDefinition.SCOPE_PROTOTYPE);</span><br><span class="line">	beanDefinition.setSynthetic(<span class="keyword">true</span>);</span><br><span class="line">	beanDefinition.getPropertyValues().add(EXPRESSION, expression);</span><br><span class="line">	<span class="keyword">return</span> beanDefinition;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到我们把pointcut属性对应的值注入到了AspectJExpressionPointcut的expresssion属性中。</p>
<p>而且要注意这个Bean是原型bean，而我们Spring默认的bean都是单例的。所以当节点中的属性是pointcut时，我们是要给出expression表达式，而对应的Bean是Spring默认给出的。</p>
<p>3.如果节点有pointcut-ref属性，我们直接返回属性值，也就是一个String对象。</p>
<p>2.当得到要注入的pointcut后，根据他的类型来选择不同的操作，如果是pointcut属性，即注入的是一个Bean定义时，我们除了要做必要的注入到构造方法里之外，我们需要把他注入到beanDefinitions这个Bean定义的list中。如果是pointcut-ref,即是String类型，那么额外的操作则变成了把他注入到beanReferences这个BeanReference类型的List，BeanReference的作用这里先稍微说一句，因为有些Bean是需要依赖于其他bean的，所以就需要BeanReference，而具体什么时候起作用以及怎么起作用，我们下次再细说。</p>
<p>我们回到parseAspect方法，我们现在可以吧目光投向parseAdvice后的代码。</p>
<p>我们会将得到的advisorDefinition加入到beanDefinitions。</p>
<p>然后新建一个AspectComponentDefinition实例，里面注入了beanDefinitions和beanReferences。</p>
<p>最后，我们需要对aspect下面的pointcut子节点进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Element&gt; pointcuts = DomUtils.getChildElementsByTagName(aspectElement, POINTCUT);</span><br><span class="line">	<span class="keyword">for</span> (Element pointcutElement : pointcuts) &#123;</span><br><span class="line">		parsePointcut(pointcutElement, parserContext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	parserContext.popAndRegisterContainingComponent();</span><br></pre></td></tr></table></figure>
<p>先得到所有的poincut节点，然后调用parsePointcut注册pointcut的信息，最后会向Spring容器注册一个PointcutComponentDefinition组件。</p>
<p>最后将所有aspect相关信息组成的aspectComponentDefinition注入到Spring容器中。</p>
<p>然后回到parse方法，注入CompositeComponentDefinition到Spring容器中。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cong96.github.io/2018/01/21/--Spring源码之AOP/" data-id="cjcouzso30000n8bzgj3axs8k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/01/21/Spring AOP源码​/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Spring AOP源码（一）
        
      </div>
    </a>
  
  
    <a href="/2018/01/17/session/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Cookie和Session</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-WEB/">Java WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWEB/">JavaWEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringMVC/">SpringMVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-css/">js&&css</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/31/DelegatingFilterProxy/">DelegatingFilterProxy</a>
          </li>
        
          <li>
            <a href="/2018/01/31/--Java中的引用传递/">Java中的引用传递</a>
          </li>
        
          <li>
            <a href="/2018/01/31/--装饰者模式/">装饰者模式(一)</a>
          </li>
        
          <li>
            <a href="/2018/01/24/--CSS笔记（一）/">CSS笔记（一）</a>
          </li>
        
          <li>
            <a href="/2018/01/24/--JDK1.8中接口的新特性/">JDK1.8中接口的新特性</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>