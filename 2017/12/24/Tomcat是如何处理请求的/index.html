<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tomcat是如何处理请求的 | 迷途书童的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言今天我们来看看Tomcat是如何处理请求的。之前已经讲到了  adapter.service(request, response);了，我们就接着这里入手，我们知道adapter对应的是一个CoyoteAdapter。 CoyoteAdapterservice(request, response) 12345678">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat是如何处理请求的">
<meta property="og:url" content="https://cong96.github.io/2017/12/24/Tomcat是如何处理请求的/index.html">
<meta property="og:site_name" content="迷途书童的博客">
<meta property="og:description" content="前言今天我们来看看Tomcat是如何处理请求的。之前已经讲到了  adapter.service(request, response);了，我们就接着这里入手，我们知道adapter对应的是一个CoyoteAdapter。 CoyoteAdapterservice(request, response) 12345678910111213141516171819202122232425262728">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-24T07:15:33.327Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tomcat是如何处理请求的">
<meta name="twitter:description" content="前言今天我们来看看Tomcat是如何处理请求的。之前已经讲到了  adapter.service(request, response);了，我们就接着这里入手，我们知道adapter对应的是一个CoyoteAdapter。 CoyoteAdapterservice(request, response) 12345678910111213141516171819202122232425262728">
  
    <link rel="alternate" href="/atom.xml" title="迷途书童的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">迷途书童的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一天进步一点</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cong96.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Tomcat是如何处理请求的" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/24/Tomcat是如何处理请求的/" class="article-date">
  <time datetime="2017-12-24T13:56:35.265Z" itemprop="datePublished">2017-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java-WEB/">Java WEB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Tomcat是如何处理请求的
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天我们来看看Tomcat是如何处理请求的。之前已经讲到了  adapter.service(request, response);了，我们就接着这里入手，我们知道adapter对应的是一个CoyoteAdapter。</p>
<h3 id="CoyoteAdapter"><a href="#CoyoteAdapter" class="headerlink" title="CoyoteAdapter"></a><strong>CoyoteAdapter</strong></h3><p><strong>service(request, response)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Service method.</span><br><span class="line">    */</span><br><span class="line">   @Override</span><br><span class="line">   public void service(org.apache.coyote.Request req,</span><br><span class="line">                       org.apache.coyote.Response res)</span><br><span class="line">       throws Exception &#123;</span><br><span class="line">//一开始就是将org.apache.coyote.Request/Response转为org.apache.catalina.connector.Request/Response</span><br><span class="line">//</span><br><span class="line">       Request request = (Request) req.getNote(ADAPTER_NOTES);</span><br><span class="line">       Response response = (Response) res.getNote(ADAPTER_NOTES);</span><br><span class="line"></span><br><span class="line">       if (request == null) &#123;</span><br><span class="line"></span><br><span class="line">           // Create objects</span><br><span class="line">           request = connector.createRequest();</span><br><span class="line">           request.setCoyoteRequest(req);</span><br><span class="line">           response = connector.createResponse();</span><br><span class="line">           response.setCoyoteResponse(res);</span><br><span class="line"></span><br><span class="line">           // Link objects</span><br><span class="line">           request.setResponse(response);</span><br><span class="line">           response.setRequest(request);</span><br><span class="line"></span><br><span class="line">           // Set as notes</span><br><span class="line">           req.setNote(ADAPTER_NOTES, request);</span><br><span class="line">           res.setNote(ADAPTER_NOTES, response);</span><br><span class="line"></span><br><span class="line">           // Set query string encoding</span><br><span class="line">           req.getParameters().setQueryStringEncoding</span><br><span class="line">               (connector.getURIEncoding());</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">           postParseSuccess = postParseRequest(req, request, res, response);</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">               // Calling the container</span><br><span class="line"> //然后就是开始调用请求相应的Servlet的              connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; catch (IOException e) &#123;</span><br><span class="line">           // Ignore</span><br><span class="line">       &#125; finally &#123;</span><br><span class="line">         </span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的作用：</p>
<p>1.将Request转化为继承了HttpServletRequest的org.apache.catalina.connector.Request</p>
<p>2.通过postParseRequest(req, request, res, response);得到对应的context和warpper</p>
<p>3.调用了相应的方法来处理请求。即connector.getService().getContainer()..getFirst().invoke(request, response);这是我们重点要关注的内容</p>
<p>第一条就不多说了</p>
<p>我们先说第二条</p>
<p>postParseRequest</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">while (mapRequired) &#123;</span><br><span class="line">           // This will map the the latest version by default</span><br><span class="line">           connector.getMapper().map(serverName, decodedURI, version,</span><br><span class="line">                                     request.getMappingData());</span><br><span class="line">           request.setContext((Context) request.getMappingData().context);</span><br><span class="line">           request.setWrapper((Wrapper) request.getMappingData().wrapper);</span><br><span class="line"></span><br><span class="line">           // If there is no context at this point, it is likely no ROOT context</span><br><span class="line">           // has been deployed</span><br><span class="line">           if (request.getContext() == null) &#123;</span><br><span class="line">               res.setStatus(404);</span><br><span class="line">               res.setMessage(&quot;Not found&quot;);</span><br><span class="line">               // No context, so use host</span><br><span class="line">               Host host = request.getHost();</span><br><span class="line">               // Make sure there is a host (might not be during shutdown)</span><br><span class="line">               if (host != null) &#123;</span><br><span class="line">                   host.logAccess(request, response, 0, true);</span><br><span class="line">               &#125;</span><br><span class="line">               return false;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>
<p>这里就给出了该请求的context和warpper,这里就涉及到了如何找到request请求对应的Servlet了。</p>
<p>我们需要关注</p>
<p>   connector.getMapper().map(serverName, decodedURI, version,      request.getMappingData());</p>
<p>通过这个方法找到对应的Servlet。</p>
<p>我们来分析一下这个方法：</p>
<p> connector.getMapper()调用的是Connector类的mapper属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapper.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Mapper mapper = <span class="keyword">new</span> Mapper();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapper listener.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> MapperListener mapperListener = <span class="keyword">new</span> MapperListener(mapper, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>所以调用的是Mapper的mapper()方法</p>
<p>看到这个方法名，我们就可以想到，肯定是去到一个集合里面去匹配我们对应的Servlet和Context等信息。那么我们就必须要知道全部的Servlet等信息是何时放入Mapper的集合里面的。</p>
<p>到底是在哪里注册了这些信息到Mapper里呢。</p>
<p>我们要回到connector.start()</p>
<p>我们看到Connector的startInternal()方法，我们可以看到方法的最后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> protected void startInternal() throws LifecycleException &#123;</span><br><span class="line"></span><br><span class="line">     // Validate settings before starting</span><br><span class="line">     if (getPort() &lt; 0) &#123;</span><br><span class="line">         throw new LifecycleException(sm.getString(</span><br><span class="line">                 &quot;coyoteConnector.invalidPort&quot;, Integer.valueOf(getPort())));</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">     try &#123;</span><br><span class="line">         protocolHandler.start();</span><br><span class="line">     &#125; catch (Exception e) &#123;</span><br><span class="line">         String errPrefix = &quot;&quot;;</span><br><span class="line">         if(this.service != null) &#123;</span><br><span class="line">             errPrefix += &quot;service.getName(): \&quot;&quot; + this.service.getName() + &quot;\&quot;; &quot;;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         throw new LifecycleException</span><br><span class="line">             (errPrefix + &quot; &quot; + sm.getString</span><br><span class="line">              (&quot;coyoteConnector.protocolHandlerStartFailed&quot;), e);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     mapperListener.start();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>最后调用了mapperListener.start();</p>
<p>而mapperListener的初始化用到了Mapper</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected MapperListener mapperListener = new MapperListener(mapper, this);</span><br></pre></td></tr></table></figure>
<p>是的，注册信息到Mapper里就是通过mapperListener.start();</p>
<p><strong>mapperListener.start()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find any components that have already been initialized since the</span></span><br><span class="line">        <span class="comment">// MBean listener won't be notified as those components will have</span></span><br><span class="line">        <span class="comment">// already registered their MBeans</span></span><br><span class="line">        findDefaultHost();</span><br><span class="line"></span><br><span class="line">        Engine engine = (Engine) connector.getService().getContainer();</span><br><span class="line">        addListeners(engine);</span><br><span class="line"></span><br><span class="line">        Container[] conHosts = engine.findChildren();</span><br><span class="line">        <span class="keyword">for</span> (Container conHost : conHosts) &#123;</span><br><span class="line">            Host host = (Host) conHost;</span><br><span class="line">            <span class="keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;</span><br><span class="line">                <span class="comment">// Registering the host will register the context and wrappers</span></span><br><span class="line">                registerHost(host);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerHost</span><span class="params">(Host host)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String[] aliases = host.findAliases();</span><br><span class="line">        mapper.addHost(host.getName(), aliases, host);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Container container : host.findChildren()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (container.getState().isAvailable()) &#123;</span><br><span class="line">                registerContext((Context) container);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(<span class="string">"mapperListener.registerHost"</span>,</span><br><span class="line">                    host.getName(), domain, connector));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String contextPath = context.getPath();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"/"</span>.equals(contextPath)) &#123;</span><br><span class="line">            contextPath = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Container host = context.getParent();</span><br><span class="line"></span><br><span class="line">        javax.naming.Context resources = context.getResources();</span><br><span class="line">        String[] welcomeFiles = context.findWelcomeFiles();</span><br><span class="line">        List&lt;WrapperMappingInfo&gt; wrappers = <span class="keyword">new</span> ArrayList&lt;WrapperMappingInfo&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Container container : context.findChildren()) &#123;</span><br><span class="line">            prepareWrapperMappingInfo(context, (Wrapper) container, wrappers);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(sm.getString(<span class="string">"mapperListener.registerWrapper"</span>,</span><br><span class="line">                        container.getName(), contextPath, connector));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mapper.addContextVersion(host.getName(), host, contextPath,</span><br><span class="line">                context.getWebappVersion(), context, welcomeFiles, resources,</span><br><span class="line">                wrappers, context.getMapperContextRootRedirectEnabled(),</span><br><span class="line">                context.getMapperDirectoryRedirectEnabled());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(<span class="string">"mapperListener.registerContext"</span>,</span><br><span class="line">                    contextPath, connector));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这段代码就是将Host,Context以及Warpper都注册到Mapper中，我们这里着重讲一下Warpper的注册。</p>
<p><strong>registerContext</strong></p>
<p>先通过prepareWrapperMappingInfo将Warpper包装成WrapperMappingInfo，然后再通过addContextVersion将WrapperMappingInfo注册到Mapper中</p>
<p><strong>mapper.addContextVersion</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addContextVersion</span><span class="params">(String hostName, Object host, String path,</span></span></span><br><span class="line"><span class="function"><span class="params">            String version, Object context, String[] welcomeResources,</span></span></span><br><span class="line"><span class="function"><span class="params">            javax.naming.Context resources, Collection&lt;WrapperMappingInfo&gt; wrappers,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> mapperContextRootRedirectEnabled, <span class="keyword">boolean</span> mapperDirectoryRedirectEnabled)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Host mappedHost = exactFind(hosts, hostName);</span><br><span class="line"><span class="comment">//...省略了大段代码</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mappedHost) &#123;</span><br><span class="line">            ContextVersion newContextVersion = <span class="keyword">new</span> ContextVersion(version, context);</span><br><span class="line">            newContextVersion.path = path;</span><br><span class="line">            newContextVersion.slashCount = slashCount;</span><br><span class="line">            newContextVersion.welcomeResources = welcomeResources;</span><br><span class="line">            newContextVersion.resources = resources;</span><br><span class="line">            newContextVersion.mapperContextRootRedirectEnabled = mapperContextRootRedirectEnabled;</span><br><span class="line">            newContextVersion.mapperDirectoryRedirectEnabled = mapperDirectoryRedirectEnabled;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (wrappers != <span class="keyword">null</span>) &#123;</span><br><span class="line">                addWrappers(newContextVersion, wrappers);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>主要是addWrappers(newContextVersion, wrappers);完成了注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void addWrappers(ContextVersion contextVersion,</span><br><span class="line">          Collection&lt;WrapperMappingInfo&gt; wrappers) &#123;</span><br><span class="line">      for (WrapperMappingInfo wrapper : wrappers) &#123;</span><br><span class="line">          addWrapper(contextVersion, wrapper.getMapping(),</span><br><span class="line">                  wrapper.getWrapper(), wrapper.isJspWildCard(),</span><br><span class="line">                  wrapper.isResourceOnly());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>终于到了最终注册的方法</p>
<p><strong>addWrapper()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addWrapper</span><span class="params">(ContextVersion context, String path,</span></span></span><br><span class="line"><span class="function"><span class="params">           Object wrapper, <span class="keyword">boolean</span> jspWildCard, <span class="keyword">boolean</span> resourceOnly)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span> (context) &#123;</span><br><span class="line">           <span class="keyword">if</span> (path.endsWith(<span class="string">"/*"</span>)) &#123;</span><br><span class="line">               <span class="comment">// Wildcard wrapper</span></span><br><span class="line">               String name = path.substring(<span class="number">0</span>, path.length() - <span class="number">2</span>);</span><br><span class="line">               Wrapper newWrapper = <span class="keyword">new</span> Wrapper(name, wrapper, jspWildCard,</span><br><span class="line">                       resourceOnly);</span><br><span class="line">               Wrapper[] oldWrappers = context.wildcardWrappers;</span><br><span class="line">               Wrapper[] newWrappers =</span><br><span class="line">                   <span class="keyword">new</span> Wrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">               <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                   context.wildcardWrappers = newWrappers;</span><br><span class="line">                   <span class="keyword">int</span> slashCount = slashCount(newWrapper.name);</span><br><span class="line">                   <span class="keyword">if</span> (slashCount &gt; context.nesting) &#123;</span><br><span class="line">                       context.nesting = slashCount;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">"*."</span>)) &#123;</span><br><span class="line">               <span class="comment">// Extension wrapper</span></span><br><span class="line">               String name = path.substring(<span class="number">2</span>);</span><br><span class="line">               Wrapper newWrapper = <span class="keyword">new</span> Wrapper(name, wrapper, jspWildCard,</span><br><span class="line">                       resourceOnly);</span><br><span class="line">               Wrapper[] oldWrappers = context.extensionWrappers;</span><br><span class="line">               Wrapper[] newWrappers =</span><br><span class="line">                   <span class="keyword">new</span> Wrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">               <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                   context.extensionWrappers = newWrappers;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.equals(<span class="string">"/"</span>)) &#123;</span><br><span class="line">               <span class="comment">// Default wrapper</span></span><br><span class="line">               Wrapper newWrapper = <span class="keyword">new</span> Wrapper(<span class="string">""</span>, wrapper, jspWildCard,</span><br><span class="line">                       resourceOnly);</span><br><span class="line">               context.defaultWrapper = newWrapper;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Exact wrapper</span></span><br><span class="line">               <span class="keyword">final</span> String name;</span><br><span class="line">               <span class="keyword">if</span> (path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// Special case for the Context Root mapping which is</span></span><br><span class="line">                   <span class="comment">// treated as an exact match</span></span><br><span class="line">                   name = <span class="string">"/"</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   name = path;</span><br><span class="line">               &#125;</span><br><span class="line">               Wrapper newWrapper = <span class="keyword">new</span> Wrapper(name, wrapper, jspWildCard,</span><br><span class="line">                       resourceOnly);</span><br><span class="line">               Wrapper[] oldWrappers = context.exactWrappers;</span><br><span class="line">               Wrapper[] newWrappers =</span><br><span class="line">                   <span class="keyword">new</span> Wrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">               <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                   context.exactWrappers = newWrappers;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法代码也非常多，他主要做了以下工作：</p>
<p>如果请求的uri是/*结尾的话就将Warpper插入到wildcardWrappers这个Warpper数组中</p>
<p>如果是以*.开始的话就将Warpper插入到extensionWrappers中</p>
<p>如果是/的话就将Warpper插入到defaultWrapper</p>
<p>如果是指定的url，没有使用通配符的话，就插入到exactWrappers中</p>
<p>到现在我们了解了Servlet,Context信息是如何注册到Mapper中了，现在可以回头来看Mapperd的mapper()方法了</p>
<p><strong>mapper()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(MessageBytes host, MessageBytes uri, String version,</span></span></span><br><span class="line"><span class="function"><span class="params">                MappingData mappingData)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (host.isNull()) &#123;</span><br><span class="line">        host.getCharChunk().append(defaultHostName);</span><br><span class="line">    &#125;</span><br><span class="line">    host.toChars();</span><br><span class="line">    uri.toChars();</span><br><span class="line">    internalMap(host.getCharChunk(), uri.getCharChunk(), version,</span><br><span class="line">            mappingData);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">internalMap</span><span class="params">(CharChunk host, CharChunk uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        String version, MappingData mappingData)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//...省略大段代码</span></span><br><span class="line">   <span class="comment">// Wrapper mapping</span></span><br><span class="line">    <span class="keyword">if</span> (!contextVersion.isPaused()) &#123;</span><br><span class="line">        internalMapWrapper(contextVersion, uri, mappingData);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我们主要关注查找匹配的Servlet的方法internalMapWrapper</p>
<p><strong>internalMapWrapper</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Wrapper mapping.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">internalMapWrapper</span><span class="params">(ContextVersion contextVersion,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         CharChunk path,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         MappingData mappingData)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> pathOffset = path.getOffset();</span><br><span class="line">       <span class="keyword">int</span> pathEnd = path.getEnd();</span><br><span class="line">       <span class="keyword">boolean</span> noServletPath = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">int</span> length = contextVersion.path.length();</span><br><span class="line">       <span class="keyword">if</span> (length == (pathEnd - pathOffset)) &#123;</span><br><span class="line">           noServletPath = <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">int</span> servletPath = pathOffset + length;</span><br><span class="line">       path.setOffset(servletPath);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Rule 1 -- Exact Match</span></span><br><span class="line">       Wrapper[] exactWrappers = contextVersion.exactWrappers;</span><br><span class="line">       internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Rule 2 -- Prefix Match</span></span><br><span class="line">       <span class="keyword">boolean</span> checkJspWelcomeFiles = <span class="keyword">false</span>;</span><br><span class="line">       Wrapper[] wildcardWrappers = contextVersion.wildcardWrappers;</span><br><span class="line">       <span class="keyword">if</span> (mappingData.wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">           internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting,</span><br><span class="line">                                      path, mappingData);</span><br><span class="line">           <span class="keyword">if</span> (mappingData.wrapper != <span class="keyword">null</span> &amp;&amp; mappingData.jspWildCard) &#123;</span><br><span class="line">               <span class="keyword">char</span>[] buf = path.getBuffer();</span><br><span class="line">               <span class="keyword">if</span> (buf[pathEnd - <span class="number">1</span>] == <span class="string">'/'</span>) &#123;</span><br><span class="line">                   <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * Path ending in '/' was mapped to JSP servlet based on</span></span><br><span class="line"><span class="comment">                    * wildcard match (e.g., as specified in url-pattern of a</span></span><br><span class="line"><span class="comment">                    * jsp-property-group.</span></span><br><span class="line"><span class="comment">                    * Force the context's welcome files, which are interpreted</span></span><br><span class="line"><span class="comment">                    * as JSP files (since they match the url-pattern), to be</span></span><br><span class="line"><span class="comment">                    * considered. See Bugzilla 27664.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                   mappingData.wrapper = <span class="keyword">null</span>;</span><br><span class="line">                   checkJspWelcomeFiles = <span class="keyword">true</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// See Bugzilla 27704</span></span><br><span class="line">                   mappingData.wrapperPath.setChars(buf, path.getStart(),</span><br><span class="line">                                                    path.getLength());</span><br><span class="line">                   mappingData.pathInfo.recycle();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(mappingData.wrapper == <span class="keyword">null</span> &amp;&amp; noServletPath &amp;&amp;</span><br><span class="line">               contextVersion.mapperContextRootRedirectEnabled) &#123;</span><br><span class="line">           <span class="comment">// The path is empty, redirect to "/"</span></span><br><span class="line">           path.append(<span class="string">'/'</span>);</span><br><span class="line">           pathEnd = path.getEnd();</span><br><span class="line">           mappingData.redirectPath.setChars</span><br><span class="line">               (path.getBuffer(), pathOffset, pathEnd - pathOffset);</span><br><span class="line">           path.setEnd(pathEnd - <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Rule 3 -- Extension Match</span></span><br><span class="line">       Wrapper[] extensionWrappers = contextVersion.extensionWrappers;</span><br><span class="line">       <span class="keyword">if</span> (mappingData.wrapper == <span class="keyword">null</span> &amp;&amp; !checkJspWelcomeFiles) &#123;</span><br><span class="line">           internalMapExtensionWrapper(extensionWrappers, path, mappingData,</span><br><span class="line">                   <span class="keyword">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Rule 4 -- Welcome resources processing for servlets</span></span><br><span class="line">       <span class="keyword">if</span> (mappingData.wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">boolean</span> checkWelcomeFiles = checkJspWelcomeFiles;</span><br><span class="line">           <span class="keyword">if</span> (!checkWelcomeFiles) &#123;</span><br><span class="line">               <span class="keyword">char</span>[] buf = path.getBuffer();</span><br><span class="line">               checkWelcomeFiles = (buf[pathEnd - <span class="number">1</span>] == <span class="string">'/'</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (checkWelcomeFiles) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; (i &lt; contextVersion.welcomeResources.length)</span><br><span class="line">                        &amp;&amp; (mappingData.wrapper == <span class="keyword">null</span>); i++) &#123;</span><br><span class="line">                   path.setOffset(pathOffset);</span><br><span class="line">                   path.setEnd(pathEnd);</span><br><span class="line">                   path.append(contextVersion.welcomeResources[i], <span class="number">0</span>,</span><br><span class="line">                           contextVersion.welcomeResources[i].length());</span><br><span class="line">                   path.setOffset(servletPath);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Rule 4a -- Welcome resources processing for exact macth</span></span><br><span class="line">                   internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Rule 4b -- Welcome resources processing for prefix match</span></span><br><span class="line">                   <span class="keyword">if</span> (mappingData.wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       internalMapWildcardWrapper</span><br><span class="line">                           (wildcardWrappers, contextVersion.nesting,</span><br><span class="line">                            path, mappingData);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Rule 4c -- Welcome resources processing</span></span><br><span class="line">                   <span class="comment">//            for physical folder</span></span><br><span class="line">                   <span class="keyword">if</span> (mappingData.wrapper == <span class="keyword">null</span></span><br><span class="line">                       &amp;&amp; contextVersion.resources != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       Object file = <span class="keyword">null</span>;</span><br><span class="line">                       String pathStr = path.toString();</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           file = contextVersion.resources.lookup(pathStr);</span><br><span class="line">                       &#125; <span class="keyword">catch</span>(NamingException nex) &#123;</span><br><span class="line">                           <span class="comment">// Swallow not found, since this is normal</span></span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">if</span> (file != <span class="keyword">null</span> &amp;&amp; !(file <span class="keyword">instanceof</span> DirContext) ) &#123;</span><br><span class="line">                           internalMapExtensionWrapper(extensionWrappers, path,</span><br><span class="line">                                                       mappingData, <span class="keyword">true</span>);</span><br><span class="line">                           <span class="keyword">if</span> (mappingData.wrapper == <span class="keyword">null</span></span><br><span class="line">                               &amp;&amp; contextVersion.defaultWrapper != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               mappingData.wrapper =</span><br><span class="line">                                   contextVersion.defaultWrapper.object;</span><br><span class="line">                               mappingData.requestPath.setChars</span><br><span class="line">                                   (path.getBuffer(), path.getStart(),</span><br><span class="line">                                    path.getLength());</span><br><span class="line">                               mappingData.wrapperPath.setChars</span><br><span class="line">                                   (path.getBuffer(), path.getStart(),</span><br><span class="line">                                    path.getLength());</span><br><span class="line">                               mappingData.requestPath.setString(pathStr);</span><br><span class="line">                               mappingData.wrapperPath.setString(pathStr);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               path.setOffset(servletPath);</span><br><span class="line">               path.setEnd(pathEnd);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>代码很长，其实就是规定了几个匹配的规则：</p>
<p>Rule1：先按照指定的url匹配，看是否有注册完整的相同url对应的Servlet。即在extartWappers里面找</p>
<p>Rule2：匹配/*通配符，在wildcardWrappers中查找</p>
<p>Rule3:按照后缀名匹配 .jsp ,.jspx等，即在extensionWrappers中查找。</p>
<p>Rule4:在指定欢迎页面中查找：</p>
<p>Rule7: 按照/匹配，即defaultWrapper</p>
<p>所以按照顺序  /*的优先级要比/高，这一点在讲解SpringMVC的时候会说，这一点很重要。</p>
<p>好了，在这里就把如何查找到request匹配的Servlet等信息讲解清楚了，将这些信息注册到request中之后，我们可以关注下一步操作了。</p>
<p>首先我们可以很容器的知道connector.getService().getContainer().得到的是StandardEngine实例，那我们先把目光转移到这个类上。</p>
<p>我们发现这个类并没有实现getPipeline()方法，这个方法的实现在其父类ContainerBase中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public Pipeline getPipeline() &#123;</span><br><span class="line"></span><br><span class="line">     return (this.pipeline);</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>就是得到这个类的pipeline属性。</p>
<p>那当前这个类的pipeline属性是在哪里注入的呢。答案是初始化的时候。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public StandardEngine() &#123;</span><br><span class="line"></span><br><span class="line">    super();</span><br><span class="line">    pipeline.setBasic(new StandardEngineValve());</span><br><span class="line">    /* Set the jmvRoute using the system property jvmRoute */</span><br><span class="line">    try &#123;</span><br><span class="line">        setJvmRoute(System.getProperty(&quot;jvmRoute&quot;));</span><br><span class="line">    &#125; catch(Exception ex) &#123;</span><br><span class="line">        log.warn(sm.getString(&quot;standardEngine.jvmRouteFail&quot;));</span><br><span class="line">    &#125;</span><br><span class="line">    // By default, the engine will hold the reloading thread</span><br><span class="line">    backgroundProcessorDelay = 10;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">//StandardPipeline</span><br><span class="line">@Override</span><br><span class="line">public Valve getFirst() &#123;</span><br><span class="line">    if (first != null) &#123;</span><br><span class="line">        return first;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return basic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过上面的代码我们可以得出connector.getService().getContainer()..getFirst()对应的是StandardEngineValve实例。</p>
<p>我们把目光转向StandardEngineValve的invoke()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Select the Host to be used for this Request</span></span><br><span class="line">      Host host = request.getHost();</span><br><span class="line">      <span class="keyword">if</span> (host == <span class="keyword">null</span>) &#123;</span><br><span class="line">          response.sendError</span><br><span class="line">              (HttpServletResponse.SC_BAD_REQUEST,</span><br><span class="line">               sm.getString(<span class="string">"standardEngine.noHost"</span>, </span><br><span class="line">                            request.getServerName()));</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">          request.setAsyncSupported(host.getPipeline().isAsyncSupported());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Ask this Host to process this request</span></span><br><span class="line">      host.getPipeline().getFirst().invoke(request, response);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们发现没有做什么实际性的处理，而是将任务交由子容器Host处理。</p>
<p>我们看源码发现   host.getPipeline().getFirst()对应的是StandardHostValve，和上面一样，依然是把实际的处理交给子容器，这样的设计是不是让你想起了责任链模式呢，不慌，之后还有更流畅的责任链模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure>
<p>中间过程就不分析了，直接来到StandardWarpperValve的invoke()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!unavailable) &#123;</span><br><span class="line">                servlet = wrapper.allocate();</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the filter chain for this request</span></span><br><span class="line">        ApplicationFilterFactory factory =</span><br><span class="line">            ApplicationFilterFactory.getInstance();</span><br><span class="line">        ApplicationFilterChain filterChain =</span><br><span class="line">            factory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset comet flag value after creating the filter chain</span></span><br><span class="line">        request.setComet(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call the filter chain for this request</span></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This also calls the servlet's service() method</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp; (filterChain != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="comment">// Swallow output if needed</span></span><br><span class="line">                <span class="keyword">if</span> (context.getSwallowOutput()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        SystemLogHandler.startCapture();</span><br><span class="line">                        <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">                            request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</span><br><span class="line">                            filterChain.doFilterEvent(request.getEvent());</span><br><span class="line">                            request.setComet(<span class="keyword">true</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            filterChain.doFilter(request.getRequest(),</span><br><span class="line">                                    response.getResponse());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        String log = SystemLogHandler.stopCapture();</span><br><span class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            context.getLogger().info(log);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">                        request.getAsyncContextInternal().doInternalDispatch();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</span><br><span class="line">                        request.setComet(<span class="keyword">true</span>);</span><br><span class="line">                        filterChain.doFilterEvent(request.getEvent());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        filterChain.doFilter</span><br><span class="line">                            (request.getRequest(), response.getResponse());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的代码非常长，我只拿了一小部分过来</p>
<p>这个方法的主要作用是：</p>
<p>1.通过 servlet = wrapper.allocate();得到servlet</p>
<p>2.创建一个FilterChain链实例</p>
<p>3.调用filterChain.doFilter (request.getRequest(), response.getResponse());</p>
<p><strong>wrapper.allocate();</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public Servlet allocate() throws ServletException &#123;</span><br><span class="line"></span><br><span class="line">      // If we are currently unloading this servlet, throw an exception</span><br><span class="line">      if (unloading) &#123;</span><br><span class="line">          throw new ServletException(sm.getString(&quot;standardWrapper.unloading&quot;, getName()));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      boolean newInstance = false;</span><br><span class="line">      </span><br><span class="line">      // If not SingleThreadedModel, return the same instance every time</span><br><span class="line">      if (!singleThreadModel) &#123;</span><br><span class="line">          // Load and initialize our instance if necessary</span><br><span class="line">          if (instance == null || !instanceInitialized) &#123;</span><br><span class="line">              synchronized (this) &#123;</span><br><span class="line">                  if (instance == null) &#123;</span><br><span class="line">                      try &#123;</span><br><span class="line">                          if (log.isDebugEnabled()) &#123;</span><br><span class="line">                              log.debug(&quot;Allocating non-STM instance&quot;);</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          // Note: We don&apos;t know if the Servlet implements</span><br><span class="line">                          // SingleThreadModel until we have loaded it.</span><br><span class="line">                          instance = loadServlet();</span><br><span class="line">           </span><br><span class="line">                  if (!instanceInitialized) &#123;</span><br><span class="line">                      initServlet(instance);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>  instance = loadServlet();完成了实例化Servlet的工作</p>
<p><strong>loadServlet()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Servlet <span class="title">loadServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        Servlet servlet;</span><br><span class="line">    </span><br><span class="line">            InstanceManager instanceManager = ((StandardContext)getParent()).getInstanceManager();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                servlet = (Servlet) instanceManager.newInstance(servletClass);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line">                unavailable(<span class="keyword">null</span>);</span><br><span class="line">                <span class="comment">// Restore the context ClassLoader</span></span><br><span class="line">       </span><br><span class="line">&#125;</span><br><span class="line">            processServletSecurityAnnotation(servlet.getClass());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            initServlet(servlet);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> servlet;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<pre><code>servlet = (Servlet) instanceManager.newInstance(servletClass);
</code></pre><p>得到了Servlet实例，接着还有一个方法        initServlet(servlet);这个方法我们需要关注一下：</p>
<p>这个方法最终其实就是调用了servlet.init(ServletConfig config)，这个方法，我们肯定不陌生，只要我们接触过Servlet就一定会了解这个方法的作用，我们可以在这个方法里面通过config得到我们在servlet节点里面配置的init-param的键值对，取出我们想要的值，可是，你在使用Servlet的init()方法时，有想过到底是怎么做到的吗，下面我们就来讲讲是怎样做到的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initServlet</span><span class="params">(Servlet servlet)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (instanceInitialized &amp;&amp; !singleThreadModel) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the initialization method of this servlet</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        instanceSupport.fireInstanceEvent(InstanceEvent.BEFORE_INIT_EVENT,</span><br><span class="line">                                          servlet);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object[] args = <span class="keyword">new</span> Object[] &#123; facade &#125;;</span><br><span class="line">                SecurityUtil.doAsPrivilege(<span class="string">"init"</span>,</span><br><span class="line">                                           servlet,</span><br><span class="line">                                           classType,</span><br><span class="line">                                           args);</span><br><span class="line">                success = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                    <span class="comment">// destroy() will not be called, thus clear the reference now</span></span><br><span class="line">                    SecurityUtil.remove(servlet);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            servlet.init(facade);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        instanceInitialized = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        instanceSupport.fireInstanceEvent(InstanceEvent.AFTER_INIT_EVENT,</span><br><span class="line">                                          servlet);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnavailableException f) &#123;</span><br><span class="line">        instanceSupport.fireInstanceEvent(InstanceEvent.AFTER_INIT_EVENT,</span><br><span class="line">                                          servlet, f);</span><br><span class="line">        unavailable(f);</span><br><span class="line">        <span class="keyword">throw</span> f;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException f) &#123;</span><br><span class="line">        instanceSupport.fireInstanceEvent(InstanceEvent.AFTER_INIT_EVENT,</span><br><span class="line">                                          servlet, f);</span><br><span class="line">        <span class="comment">// If the servlet wanted to be unavailable it would have</span></span><br><span class="line">        <span class="comment">// said so, so do not call unavailable(null).</span></span><br><span class="line">        <span class="keyword">throw</span> f;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable f) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(f);</span><br><span class="line">        getServletContext().log(<span class="string">"StandardWrapper.Throwable"</span>, f );</span><br><span class="line">        instanceSupport.fireInstanceEvent(InstanceEvent.AFTER_INIT_EVENT,</span><br><span class="line">                                          servlet, f);</span><br><span class="line">        <span class="comment">// If the servlet wanted to be unavailable it would have</span></span><br><span class="line">        <span class="comment">// said so, so do not call unavailable(null).</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServletException</span><br><span class="line">            (sm.getString(<span class="string">"standardWrapper.initException"</span>, getName()), f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然代码很长，我们需要关注的只有这一行 servlet.init(facade);</p>
<p><strong>servlet.init(facade);</strong></p>
<p>很明显我们的注意力要集中到facade上，很明显是相关的配置参数信息已经注册到了facade中了，这样我们才能在程序中能够获取得到相关参数的值。</p>
<p>我们来看这个facade对应的实现类到底是什么,参看StandardWarpper的源码可知</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protected StandardWrapperFacade facade =</span><br><span class="line">    new StandardWrapperFacade(this);</span><br></pre></td></tr></table></figure>
<p>facade是StandardWarpperFacade实例，并且实例化的时候注入了StandardWarpper对象。</p>
<p>我们进入StandardWarpperFacade，查看他对ServletConfig接口方法的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public final class StandardWrapperFacade</span><br><span class="line">    implements ServletConfig &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // ----------------------------------------------------------- Constructors</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Create a new facade around a StandardWrapper.</span><br><span class="line">     */</span><br><span class="line">    public StandardWrapperFacade(StandardWrapper config) &#123;</span><br><span class="line"></span><br><span class="line">        super();</span><br><span class="line">        this.config = config;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // ----------------------------------------------------- Instance Variables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Wrapped config.</span><br><span class="line">     */</span><br><span class="line">    private ServletConfig config = null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Wrapped context (facade).</span><br><span class="line">     */</span><br><span class="line">    private ServletContext context = null;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // -------------------------------------------------- ServletConfig Methods</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getServletName() &#123;</span><br><span class="line">        return config.getServletName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ServletContext getServletContext() &#123;</span><br><span class="line">        if (context == null) &#123;</span><br><span class="line">            context = config.getServletContext();</span><br><span class="line">            if ((context != null) &amp;&amp; (context instanceof ApplicationContext))</span><br><span class="line">                context = ((ApplicationContext) context).getFacade();</span><br><span class="line">        &#125;</span><br><span class="line">        return (context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getInitParameter(String name) &#123;</span><br><span class="line">        return config.getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Enumeration&lt;String&gt; getInitParameterNames() &#123;</span><br><span class="line">        return config.getInitParameterNames();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们会发现，其实都是调用的StandardWarpper中的方法，只是做了一下封装而已，StandardWarpper也实现了ServletConfig接口。</p>
<p>首先看StandardWarpper的getServletContext()，看到底是怎样得到ServletContext接口的实现类的，这个号称是Servlet上下文的类到底是什么呢。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the servlet context with which this servlet is associated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parent == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!(parent <span class="keyword">instanceof</span> Context))</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> (((Context) parent).getServletContext());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现是调用的父容器StandardContext的getServletContext()方法，这样就对了嘛，要不然怎么能称得上是上下文呢，如果在Servlet这一层就直接取到了，那只能在单个的Servlet中使用了。</p>
<p><strong>StandardContext.getServletContext()</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public ServletContext getServletContext() &#123;</span><br><span class="line"></span><br><span class="line">    if (context == null) &#123;</span><br><span class="line">        context = new ApplicationContext(this);</span><br><span class="line">        if (altDDName != null)</span><br><span class="line">            context.setAttribute(Globals.ALT_DD_ATTR,altDDName);</span><br><span class="line">    &#125;</span><br><span class="line">    return (context.getFacade());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码很好理解，我们终于知道了代表Servlet上下文的类是ApplicationContext，在实例化的时候注入了StandardContext，显然我们可以吧该类当做StandardContext的一个包装类，而在这个类里面有包装了一个ApplicationContextFacade，我们得到的ServletContext的实现类实际上就是ApplicationContextFacade实例。其实都是封装，Java就是这样，层层封装，有兴趣的可以看看这两个类的具体实现。</p>
<p>上面讲了getServeltContext的实现，下面也要讲一个getInitParameter的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//StandardWarpperFacade</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//实际调用的StandardWarpper的方法</span></span><br><span class="line">        <span class="keyword">return</span> config.getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//StandardWarpper</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInitParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (findInitParameter(name));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> HashMap&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findInitParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parametersLock.readLock().lock();</span><br><span class="line">            <span class="keyword">return</span> parameters.get(name);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            parametersLock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInitParameter</span><span class="params">(String name, String value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parametersLock.writeLock().lock();</span><br><span class="line">            parameters.put(name, value);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            parametersLock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        fireContainerEvent(<span class="string">"addInitParameter"</span>, name);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>还记得解析WEB.xml配置文件吗，当我们把WebXML类的信息注册到StadardContext中的时候，servlet的参数配置就是通过addInitParameter添加进去的，讲到这里你就应该为什么可以取到参数了吧。</p>
<p>通过上面的分析，我们知道了<strong>ServletConfig的实现类是StandardWarpperFacade，是对StandardWarpper的一个封装。</strong></p>
<p><strong>ServletContext的实现类是ApplicationContextFacade，这是对StandardContext的封装。</strong></p>
<p><strong>创建FilterChain实例</strong></p>
<p>终于到创建FilterChain过滤连实例了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">     ApplicationFilterFactory factory =</span><br><span class="line">            ApplicationFilterFactory.getInstance();</span><br><span class="line">        ApplicationFilterChain filterChain =</span><br><span class="line">            factory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ApplicationFilterChain createFilterChain</span><br><span class="line">        (ServletRequest request, Wrapper wrapper, Servlet servlet) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get the dispatcher type</span></span><br><span class="line">        DispatcherType dispatcher = <span class="keyword">null</span>; </span><br><span class="line">        <span class="keyword">if</span> (request.getAttribute(Globals.DISPATCHER_TYPE_ATTR) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            dispatcher = (DispatcherType) request.getAttribute(</span><br><span class="line">                    Globals.DISPATCHER_TYPE_ATTR);</span><br><span class="line">        &#125;</span><br><span class="line">        String requestPath = <span class="keyword">null</span>;</span><br><span class="line">        Object attribute = request.getAttribute(</span><br><span class="line">                Globals.DISPATCHER_REQUEST_PATH_ATTR);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (attribute != <span class="keyword">null</span>)&#123;</span><br><span class="line">            requestPath = attribute.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If there is no servlet to execute, return null</span></span><br><span class="line">        <span class="keyword">if</span> (servlet == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Create and initialize a filter chain object</span></span><br><span class="line">        ApplicationFilterChain filterChain = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">            Request req = (Request) request;</span><br><span class="line">            comet = req.isComet();</span><br><span class="line">            <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">                <span class="comment">// Security: Do not recycle</span></span><br><span class="line">              <span class="comment">//创建一个FilterChain实例</span></span><br><span class="line">                filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">                <span class="keyword">if</span> (comet) &#123;</span><br><span class="line">                    req.setFilterChain(filterChain);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterChain = (ApplicationFilterChain) req.getFilterChain();</span><br><span class="line">                <span class="keyword">if</span> (filterChain == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">                    req.setFilterChain(filterChain);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Request dispatcher in use</span></span><br><span class="line">            filterChain = <span class="keyword">new</span> ApplicationFilterChain();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        filterChain.setServlet(servlet);</span><br><span class="line"></span><br><span class="line">        filterChain.setSupport</span><br><span class="line">            (((StandardWrapper)wrapper).getInstanceSupport());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Acquire the filter mappings for this Context</span></span><br><span class="line">        StandardContext context = (StandardContext) wrapper.getParent();</span><br><span class="line">  <span class="comment">//找到所有的FilterMap</span></span><br><span class="line">        FilterMap filterMaps[] = context.findFilterMaps();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are no filter mappings, we are done</span></span><br><span class="line">        <span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> (filterChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Acquire the information we will need to match filter mappings</span></span><br><span class="line">        String servletName = wrapper.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add the relevant path-mapped filters to this filter chain</span></span><br><span class="line">  <span class="comment">//找到所有符合条件的Filter</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add filters that match on servlet name second</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</span><br><span class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// FIXME - log configuration problem</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> isCometFilter = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (comet) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="comment">// Note: The try catch is there because getFilter has a lot of </span></span><br><span class="line">                    <span class="comment">// declared exceptions. However, the filter is allocated much</span></span><br><span class="line">                    <span class="comment">// earlier</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (isCometFilter) &#123;</span><br><span class="line">                    filterChain.addFilter(filterConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                filterChain.addFilter(filterConfig);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return the completed filter chain</span></span><br><span class="line">        <span class="keyword">return</span> (filterChain);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法也是巨长，他主要做了如下工作：</p>
<p>首先创建一个FilterChain实例ApplicationFilterChain</p>
<p>然后通过StandardContext得到所有的FilterMap，然后筛选出这次请求匹配的过滤器。</p>
<p>然后将这些过滤器添加到过滤链实例中。 filterChain.addFilter(filterConfig);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void addFilter(ApplicationFilterConfig filterConfig) &#123;</span><br><span class="line"></span><br><span class="line">       // Prevent the same filter being added multiple times</span><br><span class="line">       for(ApplicationFilterConfig filter:filters)</span><br><span class="line">           if(filter==filterConfig)</span><br><span class="line">               return;</span><br><span class="line"></span><br><span class="line">       if (n == filters.length) &#123;</span><br><span class="line">           ApplicationFilterConfig[] newFilters =</span><br><span class="line">               new ApplicationFilterConfig[n + INCREMENT];</span><br><span class="line">           System.arraycopy(filters, 0, newFilters, 0, n);</span><br><span class="line">           filters = newFilters;</span><br><span class="line">       &#125;</span><br><span class="line">       filters[n++] = filterConfig;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们看到就是把过滤器对应的类ApplicationFilterConfig放入到ApplicationFilterChain的filters数组中。</p>
<p>最后我们要调用ApplicationFilterConfig的doFilter来处理请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">            internalDoFilter(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Call the next filter if there is one</span></span><br><span class="line">        <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">            ApplicationFilterConfig filterConfig = filters[pos++];</span><br><span class="line">            Filter filter = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                filter = filterConfig.getFilter();</span><br><span class="line">                support.fireInstanceEvent(InstanceEvent.BEFORE_FILTER_EVENT,</span><br><span class="line">                                          filter, request, response);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">"false"</span>.equalsIgnoreCase(</span><br><span class="line">                        filterConfig.getFilterDef().getAsyncSupported())) &#123;</span><br><span class="line">                    request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</span><br><span class="line">                            Boolean.FALSE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">                    <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">                    Principal principal = </span><br><span class="line">                        ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line"></span><br><span class="line">                    Object[] args = <span class="keyword">new</span> Object[]&#123;req, res, <span class="keyword">this</span>&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege</span><br><span class="line">                        (<span class="string">"doFilter"</span>, filter, classType, args, principal);</span><br><span class="line">                    </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                    filter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</span><br><span class="line">                                          filter, request, response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</span><br><span class="line">                    support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</span><br><span class="line">                                              filter, request, response, e);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</span><br><span class="line">                    support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</span><br><span class="line">                                              filter, request, response, e);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</span><br><span class="line">                    support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</span><br><span class="line">                                              filter, request, response, e);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                e = ExceptionUtils.unwrapInvocationTargetException(e);</span><br><span class="line">                ExceptionUtils.handleThrowable(e);</span><br><span class="line">                <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</span><br><span class="line">                    support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</span><br><span class="line">                                              filter, request, response, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException</span><br><span class="line">                  (sm.getString(<span class="string">"filterChain.filter"</span>), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We fell off the end of the chain -- call the servlet instance</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">                lastServicedRequest.set(request);</span><br><span class="line">                lastServicedResponse.set(response);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            support.fireInstanceEvent(InstanceEvent.BEFORE_SERVICE_EVENT,</span><br><span class="line">                                      servlet, request, response);</span><br><span class="line">            <span class="keyword">if</span> (request.isAsyncSupported()</span><br><span class="line">                    &amp;&amp; !support.getWrapper().isAsyncSupported()) &#123;</span><br><span class="line">                request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</span><br><span class="line">                        Boolean.FALSE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Use potentially wrapped request from this point</span></span><br><span class="line">            <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</span><br><span class="line">                (response <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ServletRequest req = request;</span><br><span class="line">                    <span class="keyword">final</span> ServletResponse res = response;</span><br><span class="line">                    Principal principal = </span><br><span class="line">                        ((HttpServletRequest) req).getUserPrincipal();</span><br><span class="line">                    Object[] args = <span class="keyword">new</span> Object[]&#123;req, res&#125;;</span><br><span class="line">                    SecurityUtil.doAsPrivilege(<span class="string">"service"</span>,</span><br><span class="line">                                               servlet,</span><br><span class="line">                                               classTypeUsedInService, </span><br><span class="line">                                               args,</span><br><span class="line">                                               principal);   </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                    servlet.service(request, response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                servlet.service(request, response);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这段代码不难理解，他使用了责任链的设计模式，这种设计模式，我们已经不陌生了，在Mybatis的Cache的设计中以及讲过。这里通过遍历数组来实现，具体的实现还是值得我们细细品味的。</p>
<p>当所有的有效过滤器都执行完后，我们会执行            servlet.service(request, response);</p>
<p>来处理我们的请求，我们把返回的数据放在response中，而response已经对socket.getOutputStream封装了，所以返回的数据能够成功返回。</p>
<p>End…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cong96.github.io/2017/12/24/Tomcat是如何处理请求的/" data-id="cjbkuc3570005kkbzypnhmh18" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/24/Tomcat是如何处理web.xml的/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Tomcat是如何处理web.xml的
        
      </div>
    </a>
  
  
    <a href="/2017/12/24/Tomcat是如何接受请求的/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Tomcat Connector节点</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-WEB/">Java WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWEB/">JavaWEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringMVC/">SpringMVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-css/">js&&css</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/31/DelegatingFilterProxy/">DelegatingFilterProxy</a>
          </li>
        
          <li>
            <a href="/2018/01/31/--Java中的引用传递/">Java中的引用传递</a>
          </li>
        
          <li>
            <a href="/2018/01/31/--装饰者模式/">装饰者模式(一)</a>
          </li>
        
          <li>
            <a href="/2018/01/24/--CSS笔记（一）/">CSS笔记（一）</a>
          </li>
        
          <li>
            <a href="/2018/01/24/--JDK1.8中接口的新特性/">JDK1.8中接口的新特性</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>