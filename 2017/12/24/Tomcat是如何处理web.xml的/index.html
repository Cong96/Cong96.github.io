<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tomcat是如何处理web.xml的 | 迷途书童的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言上一篇文章，我们分析了Catalina的load()方法，这一篇文章我们就来分析下start()方法 12345678910111213141516171819202122232425262728public void start() &amp;#123;      if (getServer() == null)">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat是如何处理web.xml的">
<meta property="og:url" content="https://cong96.github.io/2017/12/24/Tomcat是如何处理web.xml的/index.html">
<meta property="og:site_name" content="迷途书童的博客">
<meta property="og:description" content="前言上一篇文章，我们分析了Catalina的load()方法，这一篇文章我们就来分析下start()方法 12345678910111213141516171819202122232425262728public void start() &amp;#123;      if (getServer() == null) &amp;#123;          load();      &amp;#125;      i">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-23T20:59:40.817Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tomcat是如何处理web.xml的">
<meta name="twitter:description" content="前言上一篇文章，我们分析了Catalina的load()方法，这一篇文章我们就来分析下start()方法 12345678910111213141516171819202122232425262728public void start() &amp;#123;      if (getServer() == null) &amp;#123;          load();      &amp;#125;      i">
  
    <link rel="alternate" href="/atom.xml" title="迷途书童的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">迷途书童的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一天进步一点</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cong96.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Tomcat是如何处理web.xml的" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/24/Tomcat是如何处理web.xml的/" class="article-date">
  <time datetime="2017-12-24T13:56:35.268Z" itemprop="datePublished">2017-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java-WEB/">Java WEB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Tomcat是如何处理web.xml的
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>上一篇文章，我们分析了Catalina的load()方法，这一篇文章我们就来分析下start()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">          load();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">          log.fatal(<span class="string">"Cannot start server. Server instance is not configured."</span>);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start the new server</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          getServer().start();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">          log.fatal(sm.getString(<span class="string">"catalina.serverStartFail"</span>), e);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              getServer().destroy();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (LifecycleException e1) &#123;</span><br><span class="line">              log.debug(<span class="string">"destroy() failed for failed Server "</span>, e1);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//...省略了一大坨代码</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到套路和之前的load()方法是一样的，这里主要还是调用了Server实例的start()方法，那我们把目光锁定在StandardServer的start()方法</p>
<p><strong>StardardServer.startInternal()</strong></p>
<p>也是一样的套路，init()的实现在祖先类中，主要的调用方法startInternal的实现也是使用了模板方法模式设计的，我们来看他在StardardServer的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">    fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>);</span><br><span class="line">    setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">    globalNamingResources.start();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Start our defined Services</span></span><br><span class="line">    <span class="keyword">synchronized</span> (servicesLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</span><br><span class="line">            services[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如出一辙，还是调用了Service实例的start()方法</p>
<p><strong>StandardService.startInternal()</strong></p>
<p>start()方法依旧是使用了模板方法模式，我们直接看statInternal()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">           log.info(sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));</span><br><span class="line">       setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start our defined Container first</span></span><br><span class="line">       <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (container) &#123;</span><br><span class="line">               container.start();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">synchronized</span> (executors) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Executor executor: executors) &#123;</span><br><span class="line">               executor.start();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start our defined Connectors second</span></span><br><span class="line">       <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">           <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// If it has already failed, don't try and start it</span></span><br><span class="line">                   <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                       connector.start();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   log.error(sm.getString(</span><br><span class="line">                           <span class="string">"standardService.connector.startFailed"</span>,</span><br><span class="line">                           connector), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法调用了三个子元素的start()方法</p>
<p>我们先来看   container.start();</p>
<p>这几个子元素的start()到需要分别使用一篇文章来讲</p>
<p><strong>container.start();</strong></p>
<p>注意了，这一部分就涉及到解析web.xml的操作了，不过别着急，我们来一层一层一步一步的分析。</p>
<p>当然我们还是要结合server.xml和createStartDigester()来确定Contianer对应的实现类</p>
<p>先给出server.xml与Contianer有关的部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;Server port=&quot;8005&quot; shutdown=&quot;SHUTDOWN&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &lt;!-- A &quot;Service&quot; is a collection of one or more &quot;Connectors&quot; that share</span><br><span class="line">       a single &quot;Container&quot; Note:  A &quot;Service&quot; is not itself a &quot;Container&quot;,</span><br><span class="line">       so you may not define subcomponents such as &quot;Valves&quot; at this level.</span><br><span class="line">       Documentation at /docs/config/service.html</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;Service name=&quot;Catalina&quot;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;Engine defaultHost=&quot;localhost&quot; name=&quot;Catalina&quot;&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!--For clustering, please take a look at documentation at:</span><br><span class="line">          /docs/cluster-howto.html  (simple how to)</span><br><span class="line">          /docs/config/cluster.html (reference documentation) --&gt;</span><br><span class="line">      &lt;!--</span><br><span class="line">      &lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;/&gt;</span><br><span class="line">      --&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords</span><br><span class="line">           via a brute-force attack --&gt;</span><br><span class="line">      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</span><br><span class="line">        &lt;!-- This Realm uses the UserDatabase configured in the global JNDI</span><br><span class="line">             resources under the key &quot;UserDatabase&quot;.  Any edits</span><br><span class="line">             that are performed against this UserDatabase are immediately</span><br><span class="line">             available for use by the Realm.  --&gt;</span><br><span class="line">        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot; resourceName=&quot;UserDatabase&quot;/&gt;</span><br><span class="line">      &lt;/Realm&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Host appBase=&quot;webapps&quot; autoDeploy=&quot;true&quot; name=&quot;localhost&quot; unpackWARs=&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="line">             Documentation at: /docs/config/valve.html --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span><br><span class="line">        --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Access log processes all example.</span><br><span class="line">             Documentation at: /docs/config/valve.html</span><br><span class="line">             Note: The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span><br><span class="line">        &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot; pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;/&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Context docBase=&quot;C:\Coding\WorkSpace\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\ROOT&quot; path=&quot;&quot; reloadable=&quot;false&quot;/&gt;&lt;Context docBase=&quot;C:\Coding\WorkSpace\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\SpringMVC&quot; path=&quot;/SpringMVC&quot; reloadable=&quot;true&quot; source=&quot;org.eclipse.jst.j2ee.server:SpringMVC&quot;/&gt;&lt;/Host&gt;</span><br><span class="line">    &lt;/Engine&gt;</span><br><span class="line">  &lt;/Service&gt;</span><br><span class="line">&lt;/Server&gt;</span><br></pre></td></tr></table></figure>
<p>只给出Contianer相关的父节点和子节点，叔叔节点以及兄弟节点都略去了。</p>
<p>我们再看下相关的解析规则是怎样定义的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">"Server/Service/"</span>));</span><br><span class="line">       digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));</span><br><span class="line">       digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">"Server/Service/Engine/Host/"</span>));</span><br><span class="line">       addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Host/Cluster/"</span>);</span><br><span class="line">       digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/Service/Engine/Host/Context/"</span>));</span><br><span class="line"></span><br><span class="line">       <span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></span><br><span class="line">       digester.addRule(<span class="string">"Server/Service/Engine"</span>,</span><br><span class="line">                        <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</span><br><span class="line">       addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Cluster/"</span>);</span><br></pre></td></tr></table></figure>
<p>EngineRuleSet的addRuleInstances</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void addRuleInstances(Digester digester) &#123;</span><br><span class="line">       </span><br><span class="line">       digester.addObjectCreate(prefix + &quot;Engine&quot;,</span><br><span class="line">                                &quot;org.apache.catalina.core.StandardEngine&quot;,</span><br><span class="line">                                &quot;className&quot;);</span><br><span class="line">       digester.addSetProperties(prefix + &quot;Engine&quot;);</span><br><span class="line">       //注册监听器</span><br><span class="line">       digester.addRule(prefix + &quot;Engine&quot;,</span><br><span class="line">                        new LifecycleListenerRule</span><br><span class="line">                        (&quot;org.apache.catalina.startup.EngineConfig&quot;,</span><br><span class="line">                         &quot;engineConfigClass&quot;));</span><br><span class="line">       digester.addSetNext(prefix + &quot;Engine&quot;,</span><br><span class="line">                           &quot;setContainer&quot;,</span><br><span class="line">                           &quot;org.apache.catalina.Container&quot;);</span><br></pre></td></tr></table></figure>
<p>HostRuleSet的addRuleInstances</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void addRuleInstances(Digester digester) &#123;</span><br><span class="line"></span><br><span class="line">        digester.addObjectCreate(prefix + &quot;Host&quot;,</span><br><span class="line">                                 &quot;org.apache.catalina.core.StandardHost&quot;,</span><br><span class="line">                                 &quot;className&quot;);</span><br><span class="line">        digester.addSetProperties(prefix + &quot;Host&quot;);</span><br><span class="line">        ......        //注册监听器</span><br><span class="line">        digester.addRule(prefix + &quot;Host&quot;, </span><br><span class="line">                         new LifecycleListenerRule</span><br><span class="line">                         (&quot;org.apache.catalina.startup.HostConfig&quot;,</span><br><span class="line">                          &quot;hostConfigClass&quot;));</span><br><span class="line">        digester.addSetNext(prefix + &quot;Host&quot;,</span><br><span class="line">                            &quot;addChild&quot;,</span><br><span class="line">                            &quot;org.apache.catalina.Container&quot;);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ContextRuleSet的addRuleInstances</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRuleInstances</span><span class="params">(Digester digester)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (create) &#123;</span><br><span class="line">           digester.addObjectCreate(prefix + <span class="string">"Context"</span>,</span><br><span class="line">                   <span class="string">"org.apache.catalina.core.StandardContext"</span>, <span class="string">"className"</span>);</span><br><span class="line">           digester.addSetProperties(prefix + <span class="string">"Context"</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           digester.addRule(prefix + <span class="string">"Context"</span>, <span class="keyword">new</span> SetContextPropertiesRule());</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>通过解析规则和xml文件我们可以得出以下结论：</p>
<p>Service里的Container对应的是StandardEngine</p>
<p>StandardEngine-&gt;StandardHost-&gt;StandardContext  （前者是后者的父容器,因为是通过addChild方法添加的，意思很明确，就是添加子容器，方法具体内容后面会讲）</p>
<p>并且StandardEngine，StandardHost都注册了监听器</p>
<p><strong>StandardEngine.startInternal()</strong></p>
<p>container.start()的start()方法依旧是采用了模板方法模式设计，所以我们直接看startInternal方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// Log our server identification information</span></span><br><span class="line">     <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">         log.info( <span class="string">"Starting Servlet Engine: "</span> + ServerInfo.getServerInfo());</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Standard container startup</span></span><br><span class="line">     <span class="keyword">super</span>.startInternal();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>你是不是发现这与之前的都不一样，这里只调用了父类的startInternal方法，本身却没有任何实现。</p>
<p>StandardEngine的直接父类和StandardServer及StandService的直接父类是不一样的，前者是ContainerBase（容器类的直接父类，直接继承LifecycleMBeanBase），而后者直接是LifecycleMBeanBase。</p>
<p>我们来看ContainerBase的startInternal()方法</p>
<p><strong>ContainerBase.startInternal()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略一坨代码</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start our child containers, if any</span></span><br><span class="line">      Container children[] = findChildren();</span><br><span class="line">      List&lt;Future&lt;Void&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;Future&lt;Void&gt;&gt;();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">          results.add(startStopExecutor.submit(<span class="keyword">new</span> StartChild(children[i])));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">boolean</span> fail = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              result.get();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              log.error(sm.getString(<span class="string">"containerBase.threadedStartFailed"</span>), e);</span><br><span class="line">              fail = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (fail) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                  sm.getString(<span class="string">"containerBase.threadedStartFailed"</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">      <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">          ((Lifecycle) pipeline).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start our thread</span></span><br><span class="line">      threadStart();</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>先说下这个方法都干了什么：</p>
<p>1.通过findChildren找到Engine的子容器Host</p>
<p>2.使用线程池来start子容器们，子容器start的线程包装在StartChild这个类中。</p>
<p>3.调用 threadStart();来</p>
<p>先看findChildren </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The child Containers belonging to this Container, keyed by name.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> HashMap&lt;String, Container&gt; children =</span><br><span class="line">      <span class="keyword">new</span> HashMap&lt;String, Container&gt;();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Container[] findChildren() &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (children) &#123;</span><br><span class="line">          Container results[] = <span class="keyword">new</span> Container[children.size()];</span><br><span class="line">          <span class="keyword">return</span> children.values().toArray(results);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>我们发现就是取出children这个属性转化为数组，那么children是什么时候注入的呢。</p>
<p> 之前我们说过了StandardHost是通过addChild注入到StandardEngine中的。所以children就是通过addchild注入的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">  //StandardEngine</span><br><span class="line">  /**</span><br><span class="line">   * Add a child Container, only if the proposed child is an implementation</span><br><span class="line">   * of Host.</span><br><span class="line">   *</span><br><span class="line">   * @param child Child container to be added</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void addChild(Container child) &#123;</span><br><span class="line"></span><br><span class="line">      if (!(child instanceof Host))</span><br><span class="line">          throw new IllegalArgumentException</span><br><span class="line">              (sm.getString(&quot;standardEngine.notHost&quot;));</span><br><span class="line">      super.addChild(child);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  //ContainerBase</span><br><span class="line">@Override</span><br><span class="line">  public void addChild(Container child) &#123;</span><br><span class="line">      if (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">          PrivilegedAction&lt;Void&gt; dp =</span><br><span class="line">              new PrivilegedAddChild(child);</span><br><span class="line">          AccessController.doPrivileged(dp);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">          addChildInternal(child);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private void addChildInternal(Container child) &#123;</span><br><span class="line"></span><br><span class="line">      if( log.isDebugEnabled() )</span><br><span class="line">          log.debug(&quot;Add child &quot; + child + &quot; &quot; + this);</span><br><span class="line">      synchronized(children) &#123;</span><br><span class="line">          if (children.get(child.getName()) != null)</span><br><span class="line">              throw new IllegalArgumentException(&quot;addChild:  Child name &apos;&quot; +</span><br><span class="line">                                                 child.getName() +</span><br><span class="line">                                                 &quot;&apos; is not unique&quot;);</span><br><span class="line">          child.setParent(this);  // May throw IAE</span><br><span class="line">          children.put(child.getName(), child);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>所以我们通过findChildren先成功的找到StandardHost数组，然后我们通过StartChild来执行StandardHost的start()操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//一个带返回值的线程</span><br><span class="line">private static class StartChild implements Callable&lt;Void&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Void call() throws LifecycleException &#123;</span><br><span class="line">        child.start();</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个线程里便执行了StandardHost的start()方法了</p>
<p>我们再看 threadStart();</p>
<p><strong>threadStart()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//*启动将定期检查会话超时的后台线程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start the background thread that will periodically check for</span></span><br><span class="line"><span class="comment">     * session timeouts.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">threadStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (thread != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (backgroundProcessorDelay &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        threadDone = <span class="keyword">false</span>;</span><br><span class="line">        String threadName = <span class="string">"ContainerBackgroundProcessor["</span> + toString() + <span class="string">"]"</span>;</span><br><span class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> ContainerBackgroundProcessor(), threadName);</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">ContainerBackgroundProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//...省略一坨代码</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">          </span><br><span class="line">                    <span class="keyword">if</span> (!threadDone) &#123;</span><br><span class="line">                        Container parent = (Container) getMappingObject();</span><br><span class="line">                        ClassLoader cl =</span><br><span class="line">                            Thread.currentThread().getContextClassLoader();</span><br><span class="line">                        <span class="keyword">if</span> (parent.getLoader() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            cl = parent.getLoader().getClassLoader();</span><br><span class="line">                        &#125;</span><br><span class="line">                        processChildren(parent, cl);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">          <span class="comment">//...省略一坨代码</span></span><br><span class="line">        &#125;</span><br><span class="line">              <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processChildren</span><span class="params">(Container container, ClassLoader cl)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (container.getLoader() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Thread.currentThread().setContextClassLoader</span><br><span class="line">                        (container.getLoader().getClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line">                container.backgroundProcess();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                log.error(<span class="string">"Exception invoking periodic operation: "</span>, t);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">            &#125;</span><br><span class="line">            Container[] children = container.findChildren();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (children[i].getBackgroundProcessorDelay() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    processChildren(children[i], cl);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Execute a periodic task, such as reloading, etc. This method will be</span></span><br><span class="line"><span class="comment">     * invoked inside the classloading context of this container. Unexpected</span></span><br><span class="line"><span class="comment">     * throwables will be caught and logged.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">backgroundProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//....省略一大坨代码</span></span><br><span class="line">        fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这一段代码看起来似乎有点长，但是都很好理解，就是开一个后台线程来不断检测环境，时刻检测是不是有reload(热部署，你懂的，不懂的自己去查一个哈)的情况出现等等，就不过多解释了，我们直接看最后一个方法：</p>
<p><strong>fireLifecycleEvent(Lifecycle.PERIODIC_EVENT, null)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</span><br><span class="line">        lifecycle.fireLifecycleEvent(type, data);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//LifecycleSupport类 ，用来构造事件对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//创建一个事件对象实例</span></span><br><span class="line">        LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</span><br><span class="line">        LifecycleListener interested[] = listeners;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interested.length; i++)</span><br><span class="line">            interested[i].lifecycleEvent(event);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可能你看这段代码会很懵逼，不知道到底在讲些什么鬼东西，那是因为我还有个重要的东西没讲到，那就是监听器的注册，我们之前在使用xml配置文件结合解析规则分析的时候有提到，这些容器都在实例化的时候注册了监听器，我们来回头看看StandardEngine的监听器的注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">digester.addRule(prefix + &quot;Engine&quot;,</span><br><span class="line">                      new LifecycleListenerRule</span><br><span class="line">                      (&quot;org.apache.catalina.startup.EngineConfig&quot;,</span><br><span class="line">                       &quot;engineConfigClass&quot;));</span><br></pre></td></tr></table></figure>
<p>我们可以知道注册的监听器是org.apache.catalina.startup.EngineConfig</p>
<p>我们再看看LifecycleListenerRule的begin方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Container c = (Container) digester.peek();</span><br><span class="line">        Container p = <span class="keyword">null</span>;</span><br><span class="line">        Object obj = digester.peek(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Container) &#123;</span><br><span class="line">            p = (Container) obj;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String className = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">//...日常省略一坨代码</span></span><br><span class="line">      <span class="comment">//中间一坨就是为了找到正确的className  </span></span><br><span class="line">        <span class="comment">// Instantiate a new LifecycleListener implementation object</span></span><br><span class="line">      <span class="comment">//实例化监听器类</span></span><br><span class="line">      Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">        LifecycleListener listener =</span><br><span class="line">            (LifecycleListener) clazz.newInstance();</span><br><span class="line">	<span class="comment">//将监听器加入到StandardEngine实例中</span></span><br><span class="line">        <span class="comment">// Add this LifecycleListener to our associated component</span></span><br><span class="line">        c.addLifecycleListener(listener);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>addLifecycleListener</strong></p>
<p>这个方法在LifecycleBase中实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//充当事件    </span></span><br><span class="line"><span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</span><br><span class="line">        lifecycle.addLifecycleListener(listener);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>熟悉观察者模式（或者说监听器模式，但是设计模式里好像没有单独交监听器模式的）的同学看到这里就应该能明白上面fireLifecycleEvent的意思了。</p>
<p>这里事件监听器是EngineConfig，事件源是LifecycleEvent，事件对象是StandardEngine</p>
<p>好了，我们现在要看我们的回调方法   interested[i].lifecycleEvent(event);了</p>
<p>这里是EngineConfig的lifecycleEvent，我们发现这个监听器，并没有对PERIODIC_EVENT这种类型的事件做出相应的动作，所以继续往下走，执行他的子容器StandardHost的相应事件。</p>
<p>用同样的方法找到StandardHost的监听器，HostConfig，我们看看这个监听器的lifecycleEvent方法，</p>
<p><strong>HostConfig.lifecycleEvent</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public void lifecycleEvent(LifecycleEvent event) &#123;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">       // Process the event that has occurred</span><br><span class="line">       if (event.getType().equals(Lifecycle.PERIODIC_EVENT)) &#123;</span><br><span class="line">           check();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>把无用的代码都删掉了，不多bb，直接进入到check()方法</p>
<p><strong>check()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Check status of all webapps.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (host.getAutoDeploy()) &#123;</span><br><span class="line">          <span class="comment">// Check for resources modification to trigger redeployment</span></span><br><span class="line">          DeployedApplication[] apps =</span><br><span class="line">              deployed.values().toArray(<span class="keyword">new</span> DeployedApplication[<span class="number">0</span>]);</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; apps.length; i++) &#123;</span><br><span class="line">              <span class="keyword">if</span> (!isServiced(apps[i].name))</span><br><span class="line">                  checkResources(apps[i], <span class="keyword">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Check for old versions of applications that can now be undeployed</span></span><br><span class="line">          <span class="keyword">if</span> (host.getUndeployOldVersions()) &#123;</span><br><span class="line">              checkUndeploy();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Hotdeploy applications</span></span><br><span class="line">          deployApps();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">   */</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployApps</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      File appBase = appBase();<span class="comment">//// 在server.xml中的Host标签指定appbase的属性为 webapps  </span></span><br><span class="line">      File configBase = configBase();</span><br><span class="line">      String[] filteredAppPaths = filterAppPaths(appBase.list());<span class="comment">////列出appBase下的所有文件、文件夹，进行过滤</span></span><br><span class="line">      <span class="comment">// Deploy XML descriptors from configBase</span></span><br><span class="line">      deployDescriptors(configBase, configBase.list());</span><br><span class="line">      <span class="comment">// Deploy WARs</span></span><br><span class="line">      deployWARs(appBase, filteredAppPaths);<span class="comment">///部署war包  </span></span><br><span class="line">      <span class="comment">// Deploy expanded folders</span></span><br><span class="line">      deployDirectories(appBase, filteredAppPaths);<span class="comment">//部署项目文件夹  </span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>平时我们发布web的时候可以直接拷贝web的目录或者war压缩包到webapps目录下的.因此这里都一一对应了,deployDirectories该方法对应的就是web目录的发布,deployWARs对应的就是war包的发布方式。</p>
<p>我们重点看deployDirectories的部署方式。</p>
<p><strong>deployDirectories</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployDirectories</span><span class="params">(File appBase, String[] files)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (files == <span class="keyword">null</span>)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      ExecutorService es = host.getStartStopExecutor();</span><br><span class="line">  <span class="comment">//为什么要使用Callable而不是Runnable呢，我想应该是想得到线程运行的结果是否有报错把。如果得不到返回，证明就是有错误，就可以抛出异常，让异常在我们想要抛出的地方抛出</span></span><br><span class="line">      List&lt;Future&lt;?&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;Future&lt;?&gt;&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (files[i].equalsIgnoreCase(<span class="string">"META-INF"</span>))</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">          <span class="keyword">if</span> (files[i].equalsIgnoreCase(<span class="string">"WEB-INF"</span>))</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">          File dir = <span class="keyword">new</span> File(appBase, files[i]);</span><br><span class="line">          <span class="keyword">if</span> (dir.isDirectory()) &#123;</span><br><span class="line">              ContextName cn = <span class="keyword">new</span> ContextName(files[i], <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (isServiced(cn.getName()) || deploymentExists(cn.getName()))</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">              results.add(es.submit(<span class="keyword">new</span> DeployDirectory(<span class="keyword">this</span>, cn, dir)));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Future&lt;?&gt; result : results) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              result.get();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              log.error(sm.getString(</span><br><span class="line">                      <span class="string">"hostConfig.deployDir.threaded.error"</span>), e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>DeployDirectory</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private static class DeployDirectory implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    private HostConfig config;</span><br><span class="line">    private ContextName cn;</span><br><span class="line">    private File dir;</span><br><span class="line"></span><br><span class="line">    public DeployDirectory(HostConfig config, ContextName cn, File dir) &#123;</span><br><span class="line">        this.config = config;</span><br><span class="line">        this.cn = cn;</span><br><span class="line">        this.dir = dir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        config.deployDirectory(cn, dir);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个用来部署的线程</p>
<p><strong>deployDirectory</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ApplicationContextXml = <span class="string">"META-INF/context.xml"</span>;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployDirectory</span><span class="params">(ContextName cn, File dir)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//...省略了一大段代码，上面是如果META-INF/context.xml存在的时候实例化StandardContext</span></span><br><span class="line">   </span><br><span class="line">          <span class="comment">//****重点在这</span></span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">                context = (Context) Class.forName(contextClass).newInstance();</span><br><span class="line">            &#125;</span><br><span class="line">	</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(host.getConfigClass());</span><br><span class="line">            LifecycleListener listener =</span><br><span class="line">                (LifecycleListener) clazz.newInstance();</span><br><span class="line">            context.addLifecycleListener(listener);</span><br><span class="line"></span><br><span class="line">            context.setName(cn.getName());</span><br><span class="line">            context.setPath(cn.getPath());</span><br><span class="line">            context.setWebappVersion(cn.getVersion());</span><br><span class="line">            context.setDocBase(cn.getBaseName());</span><br><span class="line">            host.addChild(context);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            log.error(sm.getString(<span class="string">"hostConfig.deployDir.error"</span>,</span><br><span class="line">                    dir.getAbsolutePath()), t);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">//....省略了一堆代码</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>先说下这个方法的作用吧：</p>
<p>如果META-INF/context.xml存在，Context实例对象，由XML文件中的配置来实例化，感兴趣的可以看源码，方式就是接着解析server.xml的套路。</p>
<p>如果没有这个配置文件的存在，就按我们代码给出的方式给出，代码很简单，就不解释了，要注意，在这里，已经将StandardContext设置成了StandardHost的子容器了，并且也给StandardContext注册了监听器了。这里是很重要的，StandardContext和StandardHost的关系终于建立了。</p>
<p>到这里我们就把StandardEngine的start()方法分析完了。</p>
<p>下一篇文章我们将分析StandardHost的start()方法，正式揭开web.xml的处理过程。</p>
<p>从server.xml文件可以知道Host的父容器是Engine,而从org.apache.catalina.startup.Catalina类的createStartDigester可以知道server.xml的Engine标签创建的是org.apache.catalina.core.StandardEngine类的实例.从上一章分析可以知道StandardEngine的启动是在StandardService类的startInternal方法里面启动的,部分代码如下:</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cong96.github.io/2017/12/24/Tomcat是如何处理web.xml的/" data-id="cjbkuc3560004kkbzdv60rhoc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/24/Tomcat是如何处理server.xml的/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Tomcat是如何加载server.xml的
        
      </div>
    </a>
  
  
    <a href="/2017/12/24/Tomcat是如何处理请求的/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Tomcat是如何处理请求的</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-WEB/">Java WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWEB/">JavaWEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringMVC/">SpringMVC</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/24/--JDK1.8中接口的新特性/">JDK1.8中接口的新特性</a>
          </li>
        
          <li>
            <a href="/2018/01/21/Spring AOP源码​/">Spring AOP源码（一）</a>
          </li>
        
          <li>
            <a href="/2018/01/21/--Spring源码之AOP/">Spring源码之AOP</a>
          </li>
        
          <li>
            <a href="/2018/01/17/session/">Cookie和Session</a>
          </li>
        
          <li>
            <a href="/2018/01/14/对classpath的理解/">对classpath的理解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>