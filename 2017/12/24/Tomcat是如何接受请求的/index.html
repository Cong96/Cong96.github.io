<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tomcat Connector节点 | 迷途书童的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="123&amp;lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;            connectionTimeout=&quot;20000&quot;            redirectPort=&quot;8443&quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat Connector节点">
<meta property="og:url" content="https://cong96.github.io/2017/12/24/Tomcat是如何接受请求的/index.html">
<meta property="og:site_name" content="迷途书童的博客">
<meta property="og:description" content="123&amp;lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;            connectionTimeout=&quot;20000&quot;            redirectPort=&quot;8443&quot; /&amp;gt; Connector是Service的子节点 先看StandardService的startInternal() 123456789101112131415">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-12-23T22:06:54.603Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tomcat Connector节点">
<meta name="twitter:description" content="123&amp;lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;            connectionTimeout=&quot;20000&quot;            redirectPort=&quot;8443&quot; /&amp;gt; Connector是Service的子节点 先看StandardService的startInternal() 123456789101112131415">
  
    <link rel="alternate" href="/atom.xml" title="迷途书童的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">迷途书童的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一天进步一点</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://cong96.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Tomcat是如何接受请求的" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/24/Tomcat是如何接受请求的/" class="article-date">
  <time datetime="2017-12-24T13:56:35.263Z" itemprop="datePublished">2017-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java-WEB/">Java WEB</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Tomcat Connector节点
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>Connector是Service的子节点</p>
<p>先看StandardService的startInternal()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(log.isInfoEnabled())</span><br><span class="line">            log.info(sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));</span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start our defined Container first</span></span><br><span class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (container) &#123;</span><br><span class="line">                container.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (executors) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Executor executor: executors) &#123;</span><br><span class="line">                executor.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start our defined Connectors second</span></span><br><span class="line">        <span class="keyword">synchronized</span> (connectorsLock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Connector connector: connectors) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// If it has already failed, don't try and start it</span></span><br><span class="line">                    <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                        connector.start();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(sm.getString(</span><br><span class="line">                            <span class="string">"standardService.connector.startFailed"</span>,</span><br><span class="line">                            connector), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>之前我们已经分析过container.start()了，这个过程处理了web.xml。接下来就看 connector.start();为我们处理了什么吧。</p>
<p>直接看Connector的startInternal()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate settings before starting</span></span><br><span class="line">        <span class="keyword">if</span> (getPort() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(</span><br><span class="line">                    <span class="string">"coyoteConnector.invalidPort"</span>, Integer.valueOf(getPort())));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            protocolHandler.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            String errPrefix = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.service != <span class="keyword">null</span>) &#123;</span><br><span class="line">                errPrefix += <span class="string">"service.getName(): \""</span> + <span class="keyword">this</span>.service.getName() + <span class="string">"\"; "</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</span><br><span class="line">                (errPrefix + <span class="string">" "</span> + sm.getString</span><br><span class="line">                 (<span class="string">"coyoteConnector.protocolHandlerStartFailed"</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mapperListener.start();</span><br><span class="line">      </span><br><span class="line"> </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>主要执行了            protocolHandler.start();</p>
<p>protocolHandler是Connector的一个属性，在构造方法里面注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">protected</span> String protocolHandlerClassName =</span><br><span class="line">       <span class="string">"org.apache.coyote.http11.Http11Protocol"</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(String protocol)</span> </span>&#123;</span><br><span class="line">       setProtocol(protocol);</span><br><span class="line">       <span class="comment">// Instantiate protocol handler</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</span><br><span class="line">           <span class="keyword">this</span>.protocolHandler = (ProtocolHandler) clazz.newInstance();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.error(sm.getString(</span><br><span class="line">                   <span class="string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>), e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProtocol</span><span class="params">(String protocol)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (AprLifecycleListener.isAprAvailable()) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">"org.apache.coyote.ajp.AjpAprProtocol"</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">               setProtocolHandlerClassName(protocol);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">"org.apache.coyote.http11.Http11Protocol"</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">"org.apache.coyote.ajp.AjpProtocol"</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">               setProtocolHandlerClassName(protocol);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们目前分析的源码是tomcat7.0.28版本的，</p>
<p>默认使用的类是：org.apache.coyote.http11.Http11Protocol</p>
<p>而tomcat8默认使用的类是：org.apache.coyote.http11.Http11NioProtocol</p>
<p>我们发现在该类中没有显式的实现start()方法，这个方法在她的祖先类AbstractProtocol中实现</p>
<p>Http11NioProtocol/Http11Protocol-&gt;AbstractHttp11JsseProtocol\<socket>-&gt;AbstractHttp11JsseProtocol\<s></s></socket></p>
<p>-&gt;AbstractHttp11Protocol\<s>-&gt;AbstractProtocol\<s></s></s></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (getLog().isInfoEnabled())</span><br><span class="line">         getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.start"</span>,</span><br><span class="line">                 getName()));</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         endpoint.start();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         getLog().error(sm.getString(<span class="string">"abstractProtocolHandler.startError"</span>,</span><br><span class="line">                 getName()), ex);</span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> endpoint.start();</p>
<p>endpoint在Http11NioProtocol/Http11Protocol构造方法里注入</p>
<p>JIoEndpoint-&gt;AbstractEndpoint\<socket></socket></p>
<p>start()方法在AbstractEndpoint\<socket>中</socket></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public final void start() throws Exception &#123;</span><br><span class="line">    if (bindState == BindState.UNBOUND) &#123;</span><br><span class="line">        bind();</span><br><span class="line">        bindState = BindState.BOUND_ON_START;</span><br><span class="line">    &#125;</span><br><span class="line">    startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>bind()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Initialize thread count defaults for acceptor</span></span><br><span class="line">       <span class="keyword">if</span> (acceptorThreadCount == <span class="number">0</span>) &#123;</span><br><span class="line">           acceptorThreadCount = <span class="number">1</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Initialize maxConnections</span></span><br><span class="line">       <span class="keyword">if</span> (getMaxConnections() == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// User hasn't set a value - use the default</span></span><br><span class="line">           setMaxConnections(getMaxThreadsWithExecutor());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (serverSocketFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (isSSLEnabled()) &#123;</span><br><span class="line">               serverSocketFactory =</span><br><span class="line">                   handler.getSslImplementation().getServerSocketFactory(<span class="keyword">this</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               serverSocketFactory = <span class="keyword">new</span> DefaultServerSocketFactory(<span class="keyword">this</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (serverSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (getAddress() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   serverSocket = serverSocketFactory.createSocket(getPort(),</span><br><span class="line">                           getBacklog());</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   serverSocket = serverSocketFactory.createSocket(getPort(),</span><br><span class="line">                           getBacklog(), getAddress());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (BindException orig) &#123;</span><br><span class="line">               String msg;</span><br><span class="line">               <span class="keyword">if</span> (getAddress() == <span class="keyword">null</span>)</span><br><span class="line">                   msg = orig.getMessage() + <span class="string">" &lt;null&gt;:"</span> + getPort();</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                   msg = orig.getMessage() + <span class="string">" "</span> +</span><br><span class="line">                           getAddress().toString() + <span class="string">":"</span> + getPort();</span><br><span class="line">               BindException be = <span class="keyword">new</span> BindException(msg);</span><br><span class="line">               be.initCause(orig);</span><br><span class="line">               <span class="keyword">throw</span> be;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>绑定监控端口等</p>
<p><strong>startInternal()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">            running = <span class="keyword">true</span>;</span><br><span class="line">            paused = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create worker collection</span></span><br><span class="line">            <span class="keyword">if</span> (getExecutor() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                createExecutor();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            initializeConnectionLatch();</span><br><span class="line">		<span class="comment">//开启接收请求的线程</span></span><br><span class="line">            startAcceptorThreads();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start async timeout thread</span></span><br><span class="line">            Thread timeoutThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AsyncTimeout(),</span><br><span class="line">                    getName() + <span class="string">"-AsyncTimeout"</span>);</span><br><span class="line">            timeoutThread.setPriority(threadPriority);</span><br><span class="line">            timeoutThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            timeoutThread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p> startAcceptorThreads();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>da</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>.<span class="title">Acceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">int</span> errorDelay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Loop until we receive a shutdown command</span></span><br><span class="line">          <span class="keyword">while</span> (running) &#123;</span><br><span class="line"></span><br><span class="line">              <span class="comment">// Loop if endpoint is paused</span></span><br><span class="line">              <span class="keyword">while</span> (paused &amp;&amp; running) &#123;</span><br><span class="line">                  state = AcceptorState.PAUSED;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      Thread.sleep(<span class="number">50</span>);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                      <span class="comment">// Ignore</span></span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              state = AcceptorState.RUNNING;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">//if we have reached max connections, wait</span></span><br><span class="line">                  countUpOrAwaitConnection();</span><br><span class="line"></span><br><span class="line">                  Socket socket = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      <span class="comment">// Accept the next incoming connection from the server</span></span><br><span class="line">                      <span class="comment">// socket</span></span><br><span class="line">                      socket = serverSocketFactory.acceptSocket(serverSocket);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                      countDownConnection();</span><br><span class="line">                      <span class="comment">// Introduce delay if necessary</span></span><br><span class="line">                      errorDelay = handleExceptionWithDelay(errorDelay);</span><br><span class="line">                      <span class="comment">// re-throw</span></span><br><span class="line">                      <span class="keyword">throw</span> ioe;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">// Successful accept, reset the error delay</span></span><br><span class="line">                  errorDelay = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// Configure the socket</span></span><br><span class="line">                  <span class="keyword">if</span> (running &amp;&amp; !paused &amp;&amp; setSocketOptions(socket)) &#123;</span><br><span class="line">                      <span class="comment">// Hand this socket off to an appropriate processor</span></span><br><span class="line">                      <span class="keyword">if</span> (!processSocket(socket)) &#123;</span><br><span class="line">                          countDownConnection();</span><br><span class="line">                          <span class="comment">// Close socket right away</span></span><br><span class="line">                          closeSocket(socket);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      countDownConnection();</span><br><span class="line">                      <span class="comment">// Close socket right away</span></span><br><span class="line">                      closeSocket(socket);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                      log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), x);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                      log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), npe);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                  ExceptionUtils.handleThrowable(t);</span><br><span class="line">                  log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), t);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          state = AcceptorState.ENDED;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>虽然代码很多，但是主要就是做了socket.accept()的工作，接收请求。</p>
<p>处理请求使用了一个新的线程去处理，如下</p>
<p>processSocket</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Process the request from this socket</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        SocketWrapper&lt;Socket&gt; wrapper = <span class="keyword">new</span> SocketWrapper&lt;Socket&gt;(socket);</span><br><span class="line">        wrapper.setKeepAliveLeft(getMaxKeepAliveRequests());</span><br><span class="line">        wrapper.setSecure(isSSLEnabled());</span><br><span class="line">        <span class="comment">// During shutdown, executor may be null - avoid NPE</span></span><br><span class="line">        <span class="keyword">if</span> (!running) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        getExecutor().execute(<span class="keyword">new</span> SocketProcessor(wrapper));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</span><br><span class="line">        log.warn(<span class="string">"Socket processing request was rejected for:"</span>+socket,x);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        <span class="comment">// This means we got an OOM or similar creating a thread, or that</span></span><br><span class="line">        <span class="comment">// the pool and its queue are full</span></span><br><span class="line">        log.error(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将Socket对象封装成SocketWrapper对象放入到SocketProcessor这个线程中去处理数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">protected</span> SocketWrapper&lt;Socket&gt; socket = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">protected</span> SocketStatus status = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapper&lt;Socket&gt; socket)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (socket==<span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">         <span class="keyword">this</span>.socket = socket;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapper&lt;Socket&gt; socket, SocketStatus status)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">this</span>(socket);</span><br><span class="line">         <span class="keyword">this</span>.status = status;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">boolean</span> launch = <span class="keyword">false</span>;</span><br><span class="line">         <span class="keyword">synchronized</span> (socket) &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 SocketState state = SocketState.OPEN;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="comment">// SSL handshake</span></span><br><span class="line">                     serverSocketFactory.handshake(socket.getSocket());</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                     ExceptionUtils.handleThrowable(t);</span><br><span class="line">                     <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                         log.debug(sm.getString(<span class="string">"endpoint.err.handshake"</span>), t);</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="comment">// Tell to close the socket</span></span><br><span class="line">                     state = SocketState.CLOSED;</span><br><span class="line">                 &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">if</span> ((state != SocketState.CLOSED)) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (status == <span class="keyword">null</span>) &#123;</span><br><span class="line">                         state = handler.process(socket, SocketStatus.OPEN_READ);</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         state = handler.process(socket,status);</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">if</span> (state == SocketState.CLOSED) &#123;</span><br><span class="line">                     <span class="comment">// Close socket</span></span><br><span class="line">                     <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                         log.trace(<span class="string">"Closing socket:"</span>+socket);</span><br><span class="line">                     &#125;</span><br><span class="line">                     countDownConnection();</span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                         socket.getSocket().close();</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                         <span class="comment">// Ignore</span></span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN ||</span><br><span class="line">                         state == SocketState.UPGRADING ||</span><br><span class="line">                         state == SocketState.UPGRADING_TOMCAT  ||</span><br><span class="line">                         state == SocketState.UPGRADED)&#123;</span><br><span class="line">                     socket.setKeptAlive(<span class="keyword">true</span>);</span><br><span class="line">                     socket.access();</span><br><span class="line">                     launch = <span class="keyword">true</span>;</span><br><span class="line">                 &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.LONG) &#123;</span><br><span class="line">                     socket.access();</span><br><span class="line">                     waitingRequests.add(socket);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                 <span class="keyword">if</span> (launch) &#123;</span><br><span class="line">                     <span class="keyword">try</span> &#123;</span><br><span class="line">                         getExecutor().execute(<span class="keyword">new</span> SocketProcessor(socket, SocketStatus.OPEN_READ));</span><br><span class="line">                     &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</span><br><span class="line">                         log.warn(<span class="string">"Socket reprocessing request was rejected for:"</span>+socket,x);</span><br><span class="line">                         <span class="keyword">try</span> &#123;</span><br><span class="line">                             <span class="comment">//unable to handle connection at this time</span></span><br><span class="line">                             handler.process(socket, SocketStatus.DISCONNECT);</span><br><span class="line">                         &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                             countDownConnection();</span><br><span class="line">                         &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</span><br><span class="line">                         <span class="keyword">if</span> (running) &#123;</span><br><span class="line">                             log.error(sm.getString(<span class="string">"endpoint.launch.fail"</span>),</span><br><span class="line">                                     npe);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         socket = <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">// Finish up this request</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>handler.process(socket,status)；</p>
<p>调用过Http11ConnectionHandler的process方法处理，handler对象在Http11Protocol的构造方法内注入到JIoEndpoint中。</p>
<p>Http11ConnectionHandler（Http11Protocol的静态内部类） 继承AbstractConnectionHandler（AbstractProtocol的抽象静态内部类）</p>
<p>process方法在AbstractConnectionHandler中实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public Http11Protocol() &#123;</span><br><span class="line">      endpoint = new JIoEndpoint();</span><br><span class="line">      cHandler = new Http11ConnectionHandler(this);</span><br><span class="line">      ((JIoEndpoint) endpoint).setHandler(cHandler);</span><br><span class="line">      setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);</span><br><span class="line">      setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);</span><br><span class="line">      setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>) <span class="comment">// Old HTTP upgrade method has been deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; wrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">        SocketStatus status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (wrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Nothing to do. Socket has been closed.</span></span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    S socket = wrapper.getSocket();</span><br><span class="line">    <span class="keyword">if</span> (socket == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Nothing to do. Socket has been closed.</span></span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Processor&lt;S&gt; processor = connections.get(socket);</span><br><span class="line">    <span class="keyword">if</span> (status == SocketStatus.DISCONNECT &amp;&amp; processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Nothing to do. Endpoint requested a close and there is no</span></span><br><span class="line">        <span class="comment">// longer a processor associated with this socket.</span></span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wrapper.setAsync(<span class="keyword">false</span>);</span><br><span class="line">    ContainerThreadMarker.markAsContainerThread();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            processor = recycledProcessors.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            processor = createProcessor();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        initSsl(wrapper, processor);</span><br><span class="line"></span><br><span class="line">        SocketState state = SocketState.CLOSED;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (status == SocketStatus.DISCONNECT &amp;&amp;</span><br><span class="line">                    !processor.isComet()) &#123;</span><br><span class="line">                <span class="comment">// Do nothing here, just wait for it to get recycled</span></span><br><span class="line">                <span class="comment">// Don't do this for Comet we need to generate an end</span></span><br><span class="line">                <span class="comment">// event (see BZ 54022)</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isAsync() || state == SocketState.ASYNC_END) &#123;</span><br><span class="line">                state = processor.asyncDispatch(status);</span><br><span class="line">                <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">                    <span class="comment">// release() won't get called so in case this request</span></span><br><span class="line">                    <span class="comment">// takes a long time to process, remove the socket from</span></span><br><span class="line">                    <span class="comment">// the waiting requests now else the async timeout will</span></span><br><span class="line">                    <span class="comment">// fire</span></span><br><span class="line">                    getProtocol().endpoint.removeWaitingRequest(wrapper);</span><br><span class="line">                    <span class="comment">// There may be pipe-lined data to read. If the data</span></span><br><span class="line">                    <span class="comment">// isn't processed now, execution will exit this</span></span><br><span class="line">                    <span class="comment">// loop and call release() which will recycle the</span></span><br><span class="line">                    <span class="comment">// processor (and input buffer) deleting any</span></span><br><span class="line">                    <span class="comment">// pipe-lined data. To avoid this, process it now.</span></span><br><span class="line">                    state = processor.process(wrapper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isComet()) &#123;</span><br><span class="line">                state = processor.event(status);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.getUpgradeInbound() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                state = processor.upgradeDispatch();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">                state = processor.upgradeDispatch(status);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                state = processor.process(wrapper);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (state != SocketState.CLOSED &amp;&amp; processor.isAsync()) &#123;</span><br><span class="line">                state = processor.asyncPostProcess();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (state == SocketState.UPGRADING) &#123;</span><br><span class="line">                <span class="comment">// Get the HTTP upgrade handler</span></span><br><span class="line">                HttpUpgradeHandler httpUpgradeHandler =</span><br><span class="line">                        processor.getHttpUpgradeHandler();</span><br><span class="line">                <span class="comment">// Release the Http11 processor to be re-used</span></span><br><span class="line">                release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">// Create the upgrade processor</span></span><br><span class="line">                processor = createUpgradeProcessor(</span><br><span class="line">                        wrapper, httpUpgradeHandler);</span><br><span class="line">                <span class="comment">// Mark the connection as upgraded</span></span><br><span class="line">                wrapper.setUpgraded(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// Associate with the processor with the connection</span></span><br><span class="line">                connections.put(socket, processor);</span><br><span class="line">                <span class="comment">// Initialise the upgrade handler (which may trigger</span></span><br><span class="line">                <span class="comment">// some IO using the new protocol which is why the lines</span></span><br><span class="line">                <span class="comment">// above are necessary)</span></span><br><span class="line">                <span class="comment">// This cast should be safe. If it fails the error</span></span><br><span class="line">                <span class="comment">// handling for the surrounding try/catch will deal with</span></span><br><span class="line">                <span class="comment">// it.</span></span><br><span class="line">                httpUpgradeHandler.init((WebConnection) processor);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.UPGRADING_TOMCAT) &#123;</span><br><span class="line">                <span class="comment">// Get the UpgradeInbound handler</span></span><br><span class="line">                org.apache.coyote.http11.upgrade.UpgradeInbound inbound =</span><br><span class="line">                        processor.getUpgradeInbound();</span><br><span class="line">                <span class="comment">// Release the Http11 processor to be re-used</span></span><br><span class="line">                release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">// Create the light-weight upgrade processor</span></span><br><span class="line">                processor = createUpgradeProcessor(wrapper, inbound);</span><br><span class="line">                inbound.onUpgradeComplete();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                getLog().debug(<span class="string">"Socket: ["</span> + wrapper +</span><br><span class="line">                        <span class="string">"], Status in: ["</span> + status +</span><br><span class="line">                        <span class="string">"], State out: ["</span> + state + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (state == SocketState.ASYNC_END ||</span><br><span class="line">                state == SocketState.UPGRADING ||</span><br><span class="line">                state == SocketState.UPGRADING_TOMCAT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (state == SocketState.LONG) &#123;</span><br><span class="line">            <span class="comment">// In the middle of processing a request/response. Keep the</span></span><br><span class="line">            <span class="comment">// socket associated with the processor. Exact requirements</span></span><br><span class="line">            <span class="comment">// depend on type of long poll</span></span><br><span class="line">            connections.put(socket, processor);</span><br><span class="line">            longPoll(wrapper, processor);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">            <span class="comment">// In keep-alive but between requests. OK to recycle</span></span><br><span class="line">            <span class="comment">// processor. Continue to poll for the next request.</span></span><br><span class="line">            connections.remove(socket);</span><br><span class="line">            release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.SENDFILE) &#123;</span><br><span class="line">            <span class="comment">// Sendfile in progress. If it fails, the socket will be</span></span><br><span class="line">            <span class="comment">// closed. If it works, the socket either be added to the</span></span><br><span class="line">            <span class="comment">// poller (or equivalent) to await more data or processed</span></span><br><span class="line">            <span class="comment">// if there are any pipe-lined requests remaining.</span></span><br><span class="line">            connections.put(socket, processor);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.UPGRADED) &#123;</span><br><span class="line">            <span class="comment">// Need to keep the connection associated with the processor</span></span><br><span class="line">            connections.put(socket, processor);</span><br><span class="line">            <span class="comment">// Don't add sockets back to the poller if this was a</span></span><br><span class="line">            <span class="comment">// non-blocking write otherwise the poller may trigger</span></span><br><span class="line">            <span class="comment">// multiple read events which may lead to thread starvation</span></span><br><span class="line">            <span class="comment">// in the connector. The write() method will add this socket</span></span><br><span class="line">            <span class="comment">// to the poller if necessary.</span></span><br><span class="line">            <span class="keyword">if</span> (status != SocketStatus.OPEN_WRITE) &#123;</span><br><span class="line">                longPoll(wrapper, processor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Connection closed. OK to recycle the processor. Upgrade</span></span><br><span class="line">            <span class="comment">// processors are not recycled.</span></span><br><span class="line">            connections.remove(socket);</span><br><span class="line">            <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">                processor.getHttpUpgradeHandler().destroy();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (processor <span class="keyword">instanceof</span> org.apache.coyote.http11.upgrade.UpgradeProcessor) &#123;</span><br><span class="line">                <span class="comment">// NO-OP</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                release(wrapper, processor, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.net.SocketException e) &#123;</span><br><span class="line">        <span class="comment">// SocketExceptions are normal</span></span><br><span class="line">        getLog().debug(sm.getString(</span><br><span class="line">                <span class="string">"abstractConnectionHandler.socketexception.debug"</span>), e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">        <span class="comment">// IOExceptions are normal</span></span><br><span class="line">        getLog().debug(sm.getString(</span><br><span class="line">                <span class="string">"abstractConnectionHandler.ioexception.debug"</span>), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Future developers: if you discover any other</span></span><br><span class="line">    <span class="comment">// rare-but-nonfatal exceptions, catch them here, and log as</span></span><br><span class="line">    <span class="comment">// above.</span></span><br><span class="line">    <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">        <span class="comment">// any other exception or error is odd. Here we log it</span></span><br><span class="line">        <span class="comment">// with "ERROR" level, so it will show up even on</span></span><br><span class="line">        <span class="comment">// less-than-verbose logs.</span></span><br><span class="line">        getLog().error(</span><br><span class="line">                sm.getString(<span class="string">"abstractConnectionHandler.error"</span>), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Make sure socket/processor is removed from the list of current</span></span><br><span class="line">    <span class="comment">// connections</span></span><br><span class="line">    connections.remove(socket);</span><br><span class="line">    <span class="comment">// Don't try to add upgrade processors back into the pool</span></span><br><span class="line">    <span class="keyword">if</span> (!(processor <span class="keyword">instanceof</span> org.apache.coyote.http11.upgrade.UpgradeProcessor)</span><br><span class="line">            &amp;&amp; !processor.isUpgrade()) &#123;</span><br><span class="line">        release(wrapper, processor, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractHttp11Processor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RequestInfo rp = request.getRequestProcessor();</span><br><span class="line">    rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Setting up the I/O</span></span><br><span class="line">    setSocketWrapper(socketWrapper);</span><br><span class="line">  <span class="comment">//得到socket.getInputStrem 和socketgetOutoutStream</span></span><br><span class="line">    getInputBuffer().init(socketWrapper, endpoint);</span><br><span class="line">    getOutputBuffer().init(socketWrapper, endpoint);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp;</span><br><span class="line">            upgradeInbound == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">            httpUpgradeHandler == <span class="keyword">null</span> &amp;&amp; !endpoint.isPaused()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Parsing the request header</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            setRequestLineReadTimeout();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;<span class="comment">//解析请求头的第一行</span></span><br><span class="line">                <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (endpoint.isPaused()) &#123;</span><br><span class="line">                <span class="comment">// 503 - Service unavailable</span></span><br><span class="line">                response.setStatus(<span class="number">503</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                keptAlive = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// Set this every time in case limit has been changed via JMX</span></span><br><span class="line">                request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</span><br><span class="line">                request.getCookies().setLimit(getMaxCookieCount());</span><br><span class="line">                <span class="comment">// Currently only NIO will ever return false here</span></span><br><span class="line">                <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;<span class="comment">//解析剩余请求头</span></span><br><span class="line">                    <span class="comment">// We've read part of the request, don't recycle it</span></span><br><span class="line">                    <span class="comment">// instead associate it with the socket</span></span><br><span class="line">                    openSocket = <span class="keyword">true</span>;</span><br><span class="line">                    readComplete = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!disableUploadTimeout) &#123;</span><br><span class="line">                    setSocketTimeout(connectionUploadTimeout);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                getLog().debug(</span><br><span class="line">                        sm.getString(<span class="string">"http11processor.header.parse"</span>), e);</span><br><span class="line">            &#125;</span><br><span class="line">            setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(t);</span><br><span class="line">            UserDataHelper.Mode logMode = userDataHelper.getNextMode();</span><br><span class="line">            <span class="keyword">if</span> (logMode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String message = sm.getString(</span><br><span class="line">                        <span class="string">"http11processor.header.parse"</span>);</span><br><span class="line">                <span class="keyword">switch</span> (logMode) &#123;</span><br><span class="line">                    <span class="keyword">case</span> INFO_THEN_DEBUG:</span><br><span class="line">                        message += sm.getString(</span><br><span class="line">                                <span class="string">"http11processor.fallToDebug"</span>);</span><br><span class="line">                        <span class="comment">//$FALL-THROUGH$</span></span><br><span class="line">                    <span class="keyword">case</span> INFO:</span><br><span class="line">                        getLog().info(message, t);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> DEBUG:</span><br><span class="line">                        getLog().debug(message, t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 400 - Bad Request</span></span><br><span class="line">            response.setStatus(<span class="number">400</span>);</span><br><span class="line">            setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">            getAdapter().log(request, response, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">            <span class="comment">// Setting up filters, and parse some request headers</span></span><br><span class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                prepareRequest();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">                    getLog().debug(sm.getString(</span><br><span class="line">                            <span class="string">"http11processor.request.prepare"</span>), t);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 500 - Internal Server Error</span></span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                getAdapter().log(request, response, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</span><br><span class="line">            keepAlive = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            keepAlive = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process the request in the adapter</span></span><br><span class="line">        <span class="keyword">if</span> (!getErrorState().isError()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</span><br><span class="line">                adapter.service(request, response);  <span class="comment">//处理请求</span></span><br><span class="line">                <span class="comment">// Handle when the response was committed before a serious</span></span><br><span class="line">                <span class="comment">// error occurred.  Throwing a ServletException should both</span></span><br><span class="line">                <span class="comment">// set the status to 500 and set the errorException.</span></span><br><span class="line">                <span class="comment">// If we fail here, then the response is likely already</span></span><br><span class="line">                <span class="comment">// committed, so we can't try and set headers.</span></span><br><span class="line">                <span class="keyword">if</span>(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; (</span><br><span class="line">                        response.getErrorException() != <span class="keyword">null</span> ||</span><br><span class="line">                                (!isAsync() &amp;&amp;</span><br><span class="line">                                statusDropsConnection(response.getStatus())))) &#123;</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                setCometTimeouts(socketWrapper);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</span><br><span class="line">                setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (HeadersTooLargeException e) &#123;</span><br><span class="line">                getLog().error(sm.getString(<span class="string">"http11processor.request.process"</span>), e);</span><br><span class="line">                <span class="comment">// The response should not have been committed but check it</span></span><br><span class="line">                <span class="comment">// anyway to be safe</span></span><br><span class="line">                <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_NOW, e);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    response.reset();</span><br><span class="line">                    response.setStatus(<span class="number">500</span>);</span><br><span class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, e);</span><br><span class="line">                    response.setHeader(<span class="string">"Connection"</span>, <span class="string">"close"</span>); <span class="comment">// <span class="doctag">TODO:</span> Remove</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                ExceptionUtils.handleThrowable(t);</span><br><span class="line">                getLog().error(sm.getString(<span class="string">"http11processor.request.process"</span>), t);</span><br><span class="line">                <span class="comment">// 500 - Internal Server Error</span></span><br><span class="line">                response.setStatus(<span class="number">500</span>);</span><br><span class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</span><br><span class="line">                getAdapter().log(request, response, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>终于开始在这个方法里正式处理请求了，</p>
<p>我们来看看这个方法都干了什么</p>
<p>首先，一开始，我们就把Socket的输入输出流都封装到了org.apache.coyote.Request和org.apache.coyote.Response里，这一步非常重要。然后接下来就是处理请求头，请求头的处理分两部分，先只处理第一个行，然后处理其他行，并把相关信息收集到org.apache.coyote.Request中。</p>
<p>最后，关键的处理在  adapter.service(request, response);这一行，具体怎么处理，请看下一篇文章，要不然一篇文章太长了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://cong96.github.io/2017/12/24/Tomcat是如何接受请求的/" data-id="cjbkuc3590006kkbz87zo35ri" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/24/Tomcat是如何处理请求的/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Tomcat是如何处理请求的
        
      </div>
    </a>
  
  
    <a href="/2017/12/13/Mybatis中的缓存/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Mybatis中的缓存</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-WEB/">Java WEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWEB/">JavaWEB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringMVC/">SpringMVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/js-css/">js&&css</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/31/DelegatingFilterProxy/">DelegatingFilterProxy</a>
          </li>
        
          <li>
            <a href="/2018/01/31/--Java中的引用传递/">Java中的引用传递</a>
          </li>
        
          <li>
            <a href="/2018/01/31/--装饰者模式/">装饰者模式(一)</a>
          </li>
        
          <li>
            <a href="/2018/01/24/--CSS笔记（一）/">CSS笔记（一）</a>
          </li>
        
          <li>
            <a href="/2018/01/24/--JDK1.8中接口的新特性/">JDK1.8中接口的新特性</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>